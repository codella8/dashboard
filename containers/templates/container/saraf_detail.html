{% extends 'container/container_base.html' %}
{% load humanize %}
{% block title %}Almuqbil | saraf_detail{% endblock %}

{% block content %}
<div class="saraf-detail-page">
  <div class="container">
    <div class="content-wrapper">

      <!-- Header Section -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-left">
            <h1>{{ saraf.user.get_full_name|default:saraf.user }}</h1>
            <p class="saraf-id">ID: {{ saraf.id }}</p>
          </div>
          <div class="header-right">
            <a href="{% url 'containers:saraf_transactions_report' saraf.id %}" class="btn-primary">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z" />
              </svg>
              View All Transactions
            </a>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M11 9h2V7h-2v2zm0 4h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
            </svg>
            <h3>Summary</h3>
          </div>
          <div class="stat-body">
            <div class="stat-item">
              <span class="stat-label">Total Received</span>
              {% with total_received=saraf.total_received|default:0 %}
              <span class="stat-value received">{{ total_received|floatformat:0|intcomma }}</span>
              {% endwith %}
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Paid</span>
              {% with total_paid=saraf.total_paid|default:0 %}
              <span class="stat-value paid">{{ total_paid|floatformat:0|intcomma }}</span>
              {% endwith %}
            </div>
            <div class="stat-item">
              <span class="stat-label">Current Balance</span>
              {% with balance=saraf.balance|default:0 %}
              <span
                class="stat-value balance {% if balance > 0 %}positive{% elif balance < 0 %}negative{% else %}neutral{% endif %}">
                {{ balance|floatformat:0|intcomma }}
              </span>
              {% endwith %}
            </div>
          </div>
        </div>

        <div class="stat-card quick-actions">
          <div class="stat-header">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
            <h3>Quick Actions</h3>
          </div>
          <div class="stat-body">
            <a href="#" class="action-btn">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
              </svg>
              Add Transaction
            </a>
            <a href="{% url 'containers:saraf_transactions_report' saraf.id %}" class="action-btn">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path
                  d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
              </svg>
              Generate Report
            </a>
            <button class="action-btn" onclick="exportTransactions()">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
              </svg>
              Export Data
            </button>
          </div>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="section-header">
        <h2>Recent Transactions</h2>
        <div class="section-actions">
          <div class="search-box">
            <input type="text" placeholder="Search transactions..." class="search-input" id="transactionSearch">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
          </div>
          <select class="filter-select" id="transactionFilter">
            <option value="all">All Transactions</option>
            <option value="received">Only Received</option>
            <option value="paid">Only Paid</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table" id="transactionsTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="date">Date</th>
              <th class="sortable" data-sort="container">Container</th>
              <th class="sortable" data-sort="received">Received</th>
              <th class="sortable" data-sort="paid">Paid</th>
              <th class="sortable" data-sort="balance">Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for tx in transactions %}
            <tr class="data-row" data-id="{{ tx.id }}" data-date="{{ tx.transaction_time|date:'Y-m-d H:i' }}"
              data-container="{{ tx.container.container_number|default:'' }}"
              data-received="{{ tx.received_from_saraf|default:0 }}" data-paid="{{ tx.paid_by_company|default:0 }}"
              data-balance="{{ tx.balance|default:0 }}"
              data-type="{% if tx.received_from_saraf > 0 %}received{% else %}paid{% endif %}">
              <td>
                <div class="date-cell">
                  <span class="date">{{ tx.transaction_time|date:"M d, Y" }}</span>
                  <span class="time">{{ tx.transaction_time|date:"H:i" }}</span>
                </div>
              </td>
              <td>
                {% if tx.container %}
                <a href="{% url 'containers:detail' tx.container.id %}" class="container-link">
                  {{ tx.container.container_number }}
                </a>
                {% else %}
                <span class="no-container">-</span>
                {% endif %}
              </td>
              <td>
                {% if tx.received_from_saraf %}
                <div class="amount-cell received">
                  <span class="amount">{{ tx.received_from_saraf|floatformat:2|intcomma }}</span>
                </div>
                {% else %}
                <span class="amount-cell empty">-</span>
                {% endif %}
              </td>
              <td>
                {% if tx.paid_by_company %}
                <div class="amount-cell paid">
                  <span class="amount">{{ tx.paid_by_company|floatformat:2|intcomma }}</span>
                </div>
                {% else %}
                <span class="amount-cell empty">-</span>
                {% endif %}
              </td>
              <td>
                <div
                  class="amount-cell balance {% if tx.balance > 0 %}positive{% elif tx.balance < 0 %}negative{% else %}neutral{% endif %}">
                  <span class="amount">{{ tx.balance|floatformat:2|intcomma }}</span>
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <a href="{% url 'containers:saraf_transactions_report' tx.id %}" class="action-btn view-btn"
                    title="View Details">
                    <svg width="16" height="16" viewBox="0 0 24 24">
                      <path
                        d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                    </svg>
                  </a>
                  <button class="action-btn edit-btn" title="Edit" onclick="editTransaction('{{ tx.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24">
                      <path
                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr class="empty-row">
              <td colspan="6">
                <div class="empty-state">
                  <svg width="64" height="64" viewBox="0 0 24 24">
                    <path
                      d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z" />
                  </svg>
                  <h3>No Transactions Found</h3>
                  <p>This saraf doesn't have any transactions yet</p>
                  <a href="#" class="btn-primary">Add First Transaction</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if transactions|length >= 10 %}
      <div class="view-all">
        <a href="{% url 'containers:saraf_transactions' saraf.id %}" class="view-all-btn">
          View All Transactions
          <svg width="16" height="16" viewBox="0 0 24 24">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
          </svg>
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize page
    initSarafDetailPage();
  });

  function initSarafDetailPage() {
    // Initialize table sorting
    initTableSorting();

    // Initialize hover effects
    initHoverEffects();

    // Initialize search
    const searchInput = document.getElementById('transactionSearch');
    if (searchInput) {
      searchInput.addEventListener('input', debounce(filterTransactions, 300));
    }

    // Initialize filter
    const filterSelect = document.getElementById('transactionFilter');
    if (filterSelect) {
      filterSelect.addEventListener('change', filterTransactions);
    }

    // Format numbers
    formatNumbers();
  }

  // Debounce function for search
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Initialize table sorting
  function initTableSorting() {
    const headers = document.querySelectorAll('.sortable');
    headers.forEach(header => {
      header.addEventListener('click', function () {
        const sortBy = this.dataset.sort;
        sortTable(sortBy);
      });
    });
  }

  // Sort table function
  function sortTable(sortBy) {
    const table = document.getElementById('transactionsTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('.data-row'));

    if (rows.length === 0) return;

    rows.sort((a, b) => {
      const aVal = a.dataset[sortBy] || '';
      const bVal = b.dataset[sortBy] || '';

      if (sortBy === 'date') {
        return new Date(bVal) - new Date(aVal);
      } else if (sortBy === 'received' || sortBy === 'paid' || sortBy === 'balance') {
        return parseFloat(bVal) - parseFloat(aVal);
      } else {
        return aVal.localeCompare(bVal);
      }
    });

    // Update table
    rows.forEach(row => tbody.appendChild(row));
  }

  // Initialize hover effects
  function initHoverEffects() {
    const rows = document.querySelectorAll('.data-row');

    rows.forEach(row => {
      row.addEventListener('mouseenter', function () {
        requestAnimationFrame(() => {
          this.classList.add('row-hover');
        });
      });

      row.addEventListener('mouseleave', function () {
        requestAnimationFrame(() => {
          this.classList.remove('row-hover');
        });
      });
    });
  }

  // Filter transactions
  function filterTransactions() {
    const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
    const filterType = document.getElementById('transactionFilter').value;
    const rows = document.querySelectorAll('.data-row');

    rows.forEach(row => {
      const container = row.dataset.container.toLowerCase();
      const type = row.dataset.type;
      const matchesSearch = container.includes(searchTerm);
      const matchesFilter = filterType === 'all' || type === filterType;

      row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
  }

  // Format numbers with commas
  function formatNumbers() {
    document.querySelectorAll('.amount').forEach(amount => {
      const text = amount.textContent.trim();
      if (text && text !== '-') {
        const num = parseFloat(text.replace(/,/g, ''));
        if (!isNaN(num)) {
          amount.textContent = num.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
      }
    });
  }

  // Export transactions
  function exportTransactions() {
    const rows = document.querySelectorAll('.data-row');
    let csv = 'Date,Container,Received,Paid,Balance\n';

    rows.forEach(row => {
      const date = row.dataset.date;
      const container = row.dataset.container || '';
      const received = row.dataset.received || 0;
      const paid = row.dataset.paid || 0;
      const balance = row.dataset.balance || 0;

      csv += `"${date}","${container}",${received},${paid},${balance}\n`;
    });

    // Create download link
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `saraf_${document.querySelector('.saraf-id').textContent.replace('ID: ', '')}_transactions.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  // Edit transaction
  function editTransaction(transactionId) {
    alert(`Edit transaction ${transactionId} - This would open edit form`);
    // window.location = `/containers/saraf_transaction_edit/${transactionId}/`;
  }
</script>
{% endblock %}