{% extends 'container/container_base.html' %}
{% load humanize %}
{% load static %}

{% block title %} Almuqbil | saraf_detail {% endblock %}
{% block content %}
<div class="saraf-detail-page">
  <div class="container-fluid py-4">
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div
              class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
              style="width: 80px; height: 80px;">
              <i class="fas fa-user-tie fa-2x text-primary"></i>
            </div>
            <div>
              <h1 class="h2 mb-1">
                {{ user_info.full_name|default:"Unknown Saraf" }}
                <span class="badge bg-primary bg-opacity-25 text-primary ms-2">
                  <i class="fas fa-user-tag me-1"></i>SARAF
                </span>
              </h1>
              <div class="text-muted">
                <div class="d-flex flex-wrap gap-3">
                  <span><i class="fas fa-id-card me-1"></i>ID: {{ saraf.id }}</span>
                  {% if user_info.phone %}
                  <span><i class="fas fa-phone me-1"></i>{{ user_info.phone }}</span>
                  {% endif %}
                  {% if user_info.email %}
                  <span><i class="fas fa-envelope me-1"></i>{{ user_info.email }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="top-bar">
              <div class="top-actions">
                <button class="export-btn" onclick="exportToCSV()">
                  <i class="fas fa-file-export"></i> Export CSV
                </button>
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-{{ status_info.status_class }} bg-opacity-25 text-{{ status_info.status_class }}">
              <i
                class="fas fa-{% if financial_summary.balance > 0 %}arrow-up{% elif financial_summary.balance < 0 %}arrow-down{% else %}equals{% endif %} me-1"></i>
              {{ status_info.status }}
            </span>
            <span class="badge bg-secondary bg-opacity-25 text-secondary">
              <i class="fas fa-calendar me-1"></i>
              Joined: {{ user_info.date_joined|date:"M d, Y"|default:"N/A" }}
            </span>
            {% if user_info.company_name %}
            <span class="badge bg-info bg-opacity-25 text-info">
              <i class="fas fa-building me-1"></i>
              {{ user_info.company_name }}
            </span>
            {% endif %}
          </div>
        </div>

        <div class="col-md-4 mt-3 mt-md-0">
          <div class="d-flex flex-wrap gap-2 justify-content-md-end">
            <a href="{% url 'containers:saraf_list' %}" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
            <a href="{% url 'admin:containers_saraf_change' saraf.id %}" class="btn btn-outline-primary"
              target="_blank">
              <i class="fas fa-edit me-2"></i>Edit
            </a>
            <button onclick="window.print()" class="btn btn-outline-primary">
              <i class="fas fa-print me-2"></i>Print
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card balance">
        <div class="stat-icon">
          <i class="fas fa-scale-balanced"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value text-{{ status_info.status_class }}">
            AED{{ financial_summary.balance|floatformat:0|intcomma }}
          </div>
          <div class="stat-label">Current Balance</div>
          <small class="text-muted">
            {% if financial_summary.balance > 0 %}Company owes to Saraf{% elif financial_summary.balance < 0 %}Saraf owes to Company{% else %}Settled{% endif %} </small>
        </div>
      </div>

      <div class="stat-card received">
        <div class="stat-icon">
          <i class="fas fa-download"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value text-success">
            AED{{ financial_summary.total_received|floatformat:0|intcomma }}
          </div>
          <div class="stat-label">Total Received</div>
          <small class="text-muted">
            {{ financial_summary.transaction_count }} transactions
          </small>
        </div>
      </div>

      <div class="stat-card paid">
        <div class="stat-icon">
          <i class="fas fa-upload"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value text-danger">
            AED{{ financial_summary.total_paid|floatformat:0|intcomma }}
          </div>
          <div class="stat-label">Total Paid</div>
          <small class="text-muted">
            Avg: AED{{ financial_summary.avg_paid|floatformat:0|intcomma }}
          </small>
        </div>
      </div>

      <div class="stat-card transactions">
        <div class="stat-icon">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value text-primary">
            {{ financial_summary.transaction_count }}
          </div>
          <div class="stat-label">Total Transactions</div>
          <small class="text-muted">
            First: {{ financial_summary.first_transaction|date:"M d, Y"|default:"N/A" }}
          </small>
        </div>
      </div>
    </div>

    {% if currency_breakdown %}
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Currency Breakdown</h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for currency, data in currency_breakdown.items %}
          <div class="col-md-4 mb-3">
            <div class="card border h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">
                    <span class="currency-badge {{ currency }}-badge">
                      {{ currency|upper }}
                    </span>
                  </h6>
                  <span class="badge bg-light text-dark">{{ data.count }} trx</span>
                </div>

                <div class="row text-center">
                  <div class="col-6">
                    <div class="text-success mb-1">
                      <small>Received</small>
                      <div class="fw-bold">{{ data.currency_symbol }}{{ data.total_received|floatformat:0|intcomma }}
                      </div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-danger mb-1">
                      <small>Paid</small>
                      <div class="fw-bold">{{ data.currency_symbol }}{{ data.total_paid|floatformat:0|intcomma }}</div>
                    </div>
                  </div>
                </div>

                <div class="mt-3 text-center">
                  <div
                    class="fw-bold {% if data.balance > 0 %}text-success{% elif data.balance < 0 %}text-danger{% else %}text-secondary{% endif %}">
                    Balance: {{ data.currency_symbol }}{{ data.balance|floatformat:0|intcomma }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" data-tab="transactions">
          <i class="fas fa-exchange-alt me-2"></i>
          Transactions ({{ total_transactions_count }})
        </button>
        <button class="tab-btn" data-tab="containers">
          <i class="fas fa-box me-2"></i>
          Containers ({{ container_summary|length }})
        </button>
        <button class="tab-btn" data-tab="activity">
          <i class="fas fa-history me-2"></i>
          Recent Activity
        </button>
        <button class="tab-btn" data-tab="info">
          <i class="fas fa-info-circle me-2"></i>
          Information
        </button>
      </div>

      <div class="tab-content" id="transactions-tab">
        <div class="table-section">
          <div class="table-header">
            <h5 class="mb-0">Transaction History</h5>
            <div class="d-flex gap-2">
              <form method="GET" class="d-flex gap-2">
                <select name="date_filter" class="form-select form-select-sm" onchange="this.form.submit()">
                  <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                  <option value="today" {% if date_filter=='today' %}selected{% endif %}>Today</option>
                  <option value="week" {% if date_filter=='week' %}selected{% endif %}>Last 7 Days</option>
                  <option value="month" {% if date_filter=='month' %}selected{% endif %}>Last 30 Days</option>
                  <option value="year" {% if date_filter=='year' %}selected{% endif %}>Last Year</option>
                </select>
                <input type="date" name="start_date" class="form-control form-control-sm"
                  value="{{ start_date|default:'' }}" placeholder="Start Date">
                <input type="date" name="end_date" class="form-control form-control-sm"
                  value="{{ end_date|default:'' }}" placeholder="End Date">
                <button type="submit" class="btn btn-sm btn-primary">Filter</button>
                <a href="?" class="btn btn-sm btn-outline-secondary">Clear</a>
              </form>
            </div>
          </div>

          {% if transactions %}
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Container</th>
                  <th>Currency</th>
                  <th class="text-end">Received</th>
                  <th class="text-end">Paid</th>
                  <th class="text-end">Balance</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in transactions %}
                <tr>
                  <td>
                    <div class="small">{{ tx.transaction_time|date:"Y-m-d" }}</div>
                    <div class="text-muted smaller">{{ tx.transaction_time|date:"H:i" }}</div>
                  </td>
                  <td>
                    {% if tx.container %}
                    <a href="{% url 'containers:detail' tx.container.id %}" class="text-primary">
                      {{ tx.container.container_number|default:tx.container.name|truncatechars:15 }}
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-light text-dark">{{ tx.currency|upper }}</span>
                  </td>
                  <td class="text-end">
                    {% if tx.received_from_saraf %}
                    <span class="text-success fw-bold">
                      AED{{ tx.received_from_saraf|floatformat:0|intcomma }}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if tx.paid_by_company %}
                    <span class="text-danger fw-bold">
                      AED{{ tx.paid_by_company|floatformat:0|intcomma }}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <span
                      class="fw-bold {% if tx.balance > 0 %}text-success{% elif tx.balance < 0 %}text-danger{% else %}text-secondary{% endif %}">
                      AED{{ tx.balance|default:0|floatformat:0|intcomma }}
                    </span>
                  </td>
                  <td>
                    <span class="text-muted" title="{{ tx.description|default:'No description' }}">
                      {{ tx.description|truncatechars:30|default:"-" }}
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" title="View">
                        <i class="fas fa-eye"></i>
                      </button>
                      <a href="{% url 'admin:containers_saraftransaction_change' tx.id %}"
                        class="btn btn-outline-secondary" title="Edit" target="_blank">
                        <i class="fas fa-edit"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card-footer bg-white border-top py-3">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                Showing {{ transactions|length }} of {{ total_transactions_count }} transactions
              </small>
              <a href="{% url 'containers:saraf_transactions_report' saraf.id %}" class="btn btn-sm btn-primary">
                <i class="fas fa-chart-bar me-1"></i>Full Report
              </a>
            </div>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
            <h5>No Transactions Found</h5>
            <p class="text-muted">This saraf doesn't have any transactions yet.</p>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="tab-content" id="containers-tab" style="display: none;">
        {% if container_summary %}
        <div class="table-section">
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Container Number</th>
                  <th>Transactions</th>
                  <th class="text-end">Total Received</th>
                  <th class="text-end">Total Paid</th>
                  <th class="text-end">Balance</th>
                  <th>Last Transaction</th>
                </tr>
              </thead>
              <tbody>
                {% for container in container_summary %}
                <tr>
                  <td>
                    <a href="{% url 'containers:detail' container.container.id %}" class="text-primary">
                      {{ container.container.container_number|default:"N/A" }}
                    </a>
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ container.count }}</span>
                  </td>
                  <td class="text-end">
                    <span class="text-success fw-bold">
                      AED{{ container.received|floatformat:0|intcomma }}
                    </span>
                  </td>
                  <td class="text-end">
                    <span class="text-danger fw-bold">
                      AED{{ container.paid|floatformat:0|intcomma }}
                    </span>
                  </td>
                  <td class="text-end">
                    <span
                      class="fw-bold {% if container.balance > 0 %}text-success{% elif container.balance < 0 %}text-danger{% else %}text-secondary{% endif %}">
                      AED{{ container.balance|default:0|floatformat:0|intcomma }}
                    </span>
                  </td>
                  <td>
                    {{ container.last_transaction|date:"Y-m-d H:i"|default:"-" }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-box fa-3x text-muted mb-3"></i>
          <h5>No Containers Found</h5>
          <p class="text-muted">This saraf doesn't have any container transactions.</p>
        </div>
        {% endif %}
      </div>

      <div class="tab-content" id="activity-tab" style="display: none;">
        <div class="table-section">
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date & Time</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Container</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in recent_activity %}
                <tr>
                  <td>
                    <div>{{ tx.transaction_time|date:"Y-m-d" }}</div>
                    <small class="text-muted">{{ tx.transaction_time|date:"H:i:s" }}</small>
                  </td>
                  <td>
                    {% if tx.received_from_saraf %}
                    <span class="badge bg-success">Received</span>
                    {% else %}
                    <span class="badge bg-danger">Paid</span>
                    {% endif %}
                  </td>
                  <td class="fw-bold {% if tx.received_from_saraf %}text-success{% else %}text-danger{% endif %}">
                    AED{{ tx.received_from_saraf|default:tx.paid_by_company|floatformat:0|intcomma }}
                  </td>
                  <td>
                    {% if tx.container %}
                    <a href="{% url 'containers:detail' tx.container.id %}" class="text-primary">
                      {{ tx.container.container_number|truncatechars:15 }}
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>{{ tx.description|truncatechars:40|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center py-4 text-muted">
                    No recent activity found.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="tab-content" id="info-tab" style="display: none;">
        <div class="row">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-user-circle me-2"></i>Personal Information</h6>
              </div>
              <div class="card-body">
                <dl class="row mb-0">
                  <dt class="col-sm-4">Full Name:</dt>
                  <dd class="col-sm-8">{{ user_info.full_name|default:"Not provided" }}</dd>

                  <dt class="col-sm-4">Phone:</dt>
                  <dd class="col-sm-8">{{ user_info.phone|default:"Not provided" }}</dd>

                  <dt class="col-sm-4">Email:</dt>
                  <dd class="col-sm-8">{{ user_info.email|default:"Not provided" }}</dd>

                  <dt class="col-sm-4">National ID:</dt>
                  <dd class="col-sm-8">{{ user_info.national_id|default:"Not provided" }}</dd>

                  <dt class="col-sm-4">Address:</dt>
                  <dd class="col-sm-8">{{ user_info.address|default:"Not provided" }}</dd>
                </dl>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-building me-2"></i>Account Information</h6>
              </div>
              <div class="card-body">
                <dl class="row mb-0">
                  <dt class="col-sm-4">Saraf ID:</dt>
                  <dd class="col-sm-8"><code>{{ saraf.id }}</code></dd>

                  <dt class="col-sm-4">Status:</dt>
                  <dd class="col-sm-8">
                    <span class="badge bg-{{ status_info.status_class }}">
                      {% if status_info.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </dd>

                  <dt class="col-sm-4">Company:</dt>
                  <dd class="col-sm-8">{{ user_info.company_name|default:"No company" }}</dd>

                  <dt class="col-sm-4">Created:</dt>
                  <dd class="col-sm-8">{{ status_info.created_at|date:"Y-m-d H:i" }}</dd>

                  <dt class="col-sm-4">Last Updated:</dt>
                  <dd class="col-sm-8">{{ status_info.updated_at|date:"Y-m-d H:i" }}</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>

        {% if monthly_summary %}
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Summary ({{ today|date:"Y" }})</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th class="text-end">Transactions</th>
                    <th class="text-end">Received</th>
                    <th class="text-end">Paid</th>
                    <th class="text-end">Balance</th>
                  </tr>
                </thead>
                <tbody>
                  {% for month in monthly_summary %}
                  <tr>
                    <td>{{ month.month_name }}</td>
                    <td class="text-end">{{ month.count }}</td>
                    <td class="text-end text-success">AED{{ month.received|floatformat:0|intcomma }}</td>
                    <td class="text-end text-danger">AED{{ month.paid|floatformat:0|intcomma }}</td>
                    <td
                      class="text-end {% if month.balance > 0 %}text-success{% elif month.balance < 0 %}text-danger{% else %}text-secondary{% endif %}">
                      AED{{ month.balance|floatformat:0|intcomma }}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card border-0 shadow-sm mt-4">
      <div class="card-body">
        <h6 class="mb-3">Quick Actions</h6>
        <div class="d-flex flex-wrap gap-2">
          <a href="{% url 'containers:saraf_transactions_report' saraf.id %}" class="btn btn-outline-primary">
            <i class="fas fa-file-pdf me-2"></i>Generate Report
          </a>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.style.display = 'none');
      const activeBtn = document.querySelector(`.tab-btn[data-tab="AED{tabName}"]`);
      const activeContent = document.getElementById(`AED{tabName}-tab`);

      if (activeBtn) activeBtn.classList.add('active');
      if (activeContent) activeContent.style.display = 'block';
    }

    tabButtons.forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const tabName = this.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    switchTab('transactions');
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');

    if (startDateInput && endDateInput) {
      startDateInput.addEventListener('change', function () {
        endDateInput.min = this.value;
      });

      endDateInput.addEventListener('change', function () {
        if (startDateInput.value && this.value < startDateInput.value) {
          alert('End date cannot be before start date');
          this.value = '';
        }
      });
    }

    const printBtn = document.querySelector('[onclick="window.print()"]');
    if (printBtn) {
      printBtn.addEventListener('click', function () {
        window.print();
      });
    }

    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.forEach(el => {
      new bootstrap.Tooltip(el);
    });
  });
</script>
{% endblock %}