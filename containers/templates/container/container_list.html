{% extends 'container/container_base.html' %}
{% load static %}
{% block title %}Almuqbil | container_list{% endblock %}

{% block content %}
<div class="container-list-page">
  <div class="container">
    <div class="content-wrapper">
      <!-- Header Section -->
      <div class="page-header">
        <h1>Containers Management</h1>
      </div>

      <!-- Table Section -->
      <div class="table-container">
        <table class="table table-hover">
          <thead class="table-header">
            <tr>
              <th>Container Number</th>
              <th>Name</th>
              <th>Company</th>
              <th>Products</th>
              <th>Stock Qty</th>
              <th>Inventory Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody class="table-body">
            {% for container in containers %}
            <tr>
              <td>
                <a href="{% url 'containers:total_container_transactions_report' %}" class="container-number-link">
                  {{ container.container_number|default:container.id }}
                </a>
              </td>
              <td>
                <strong>{{ container.name }}</strong>
              </td>
              <td>
                <span>{{ container.company.name|default:"-" }}</span>
              </td>
              <td>
                <span class="value-badge products-count">
                  {{ container.products_count|default:0 }}
                </span>
              </td>
              <td>
                <span class="value-badge stock-qty">
                  {{ container.total_in_stock_qty|default:0 }}
                </span>
              </td>
              <td>
                <span class="value-badge inventory-value">
                  ${{ container.total_inventory_value|default:0 }}
                </span>
              </td>
              <td>
                <div class="action-buttons-cell">
                  <a class="btn btn-sm btn-outline-secondary"
                    href="{% url 'containers:container_financial_report' container_id=container.id %}">
                    üí∞ Financial
                  </a>
                  <a class="btn btn-sm btn-outline-info" href="{% url 'containers:detail' container.id %}">
                    üëÅÔ∏è Details
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7">
                <div class="empty-state">
                  <span class="empty-state-icon">üì≠</span>
                  <p>No containers found</p>
                  <small class="text-muted">Start by adding your first container</small>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
      <div class="pagination-container">
        <nav aria-label="Page navigation">
          <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                ‚Üê Previous
              </a>
            </li>
            {% endif %}

            <li class="page-item active">
              <span class="page-link">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
              </span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                Next ‚Üí
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Performance optimization: Lazy loading for hover effects
    const tableRows = document.querySelectorAll('.table-body tr');

    // Optimize hover effects with requestAnimationFrame
    tableRows.forEach(row => {
      row.addEventListener('mouseenter', function () {
        requestAnimationFrame(() => {
          this.style.backgroundColor = '#f8fafc';
        });
      });

      row.addEventListener('mouseleave', function () {
        requestAnimationFrame(() => {
          this.style.backgroundColor = '';
        });
      });
    });

    // Fast click handling for buttons
    document.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('click', function (e) {
        if (this.getAttribute('href') === '#') {
          e.preventDefault();
          // Add loading state
          const originalHTML = this.innerHTML;
          this.innerHTML = 'Loading...';
          this.style.opacity = '0.7';
          this.style.pointerEvents = 'none';

          // Simulate loading (remove this in production)
          setTimeout(() => {
            this.innerHTML = originalHTML;
            this.style.opacity = '';
            this.style.pointerEvents = '';
          }, 1000);
        }
      });
    });

    // Optimize table rendering
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          tableContainer.style.willChange = 'transform';
        }
      });
    }

    // Search functionality (optional enhancement)
    const addSearchIfNeeded = () => {
      const header = document.querySelector('.page-header');
      if (header && !document.querySelector('.search-box')) {
        const searchHTML = `
                <div class="search-box">
                    <input type="text" placeholder="Search containers..." class="search-input">
                    <button class="search-btn">Search</button>
                </div>
            `;
        header.insertAdjacentHTML('afterend', searchHTML);

        // Add search functionality
        const searchInput = document.querySelector('.search-input');
        const searchBtn = document.querySelector('.search-btn');

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => {
          if (e.key === 'Enter') performSearch();
        });
      }
    };

    const performSearch = () => {
      const searchTerm = document.querySelector('.search-input').value.toLowerCase();
      const rows = document.querySelectorAll('.table-body tr');

      rows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        if (rowText.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    };

    // Initialize search after a delay for better performance
    setTimeout(addSearchIfNeeded, 100);

    // Sort functionality (optional enhancement)
    const addSortIfNeeded = () => {
      const headers = document.querySelectorAll('.table-header th');
      headers.forEach((header, index) => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => sortTable(index));
      });
    };

    const sortTable = (columnIndex) => {
      const table = document.querySelector('.table');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Skip if it's the actions column
      if (columnIndex === 6) return;

      const isAscending = !table.dataset.sortAsc || table.dataset.sortAsc === 'false';

      rows.sort((a, b) => {
        const aText = a.children[columnIndex].textContent.trim();
        const bText = b.children[columnIndex].textContent.trim();

        // Handle numeric values
        if (columnIndex === 3 || columnIndex === 4 || columnIndex === 5) {
          const aNum = parseFloat(aText.replace(/[^0-9.-]+/g, "")) || 0;
          const bNum = parseFloat(bText.replace(/[^0-9.-]+/g, "")) || 0;
          return isAscending ? aNum - bNum : bNum - aNum;
        }

        // Handle text values
        return isAscending
          ? aText.localeCompare(bText)
          : bText.localeCompare(aText);
      });

      // Clear and re-append rows
      rows.forEach(row => tbody.appendChild(row));
      table.dataset.sortAsc = isAscending;
    };

    // Initialize sort after a delay
    setTimeout(addSortIfNeeded, 100);
  });

  // Export data functionality (optional)
  function exportToCSV() {
    const rows = document.querySelectorAll('.table-body tr');
    let csv = 'Container Number,Name,Company,Products,Stock Qty,Inventory Value\n';

    rows.forEach(row => {
      if (row.style.display !== 'none') {
        const cols = row.querySelectorAll('td');
        const rowData = [];

        cols.forEach((col, index) => {
          if (index < 6) { // Exclude actions column
            let text = col.textContent.trim();
            // Remove emojis and extra spaces
            text = text.replace(/[^\x00-\x7F]/g, '').trim();
            // Escape commas
            if (text.includes(',')) text = `"${text}"`;
            rowData.push(text);
          }
        });

        csv += rowData.join(',') + '\n';
      }
    });

    // Create download link
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'containers.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }

  // Add export button dynamically
  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(() => {
      const header = document.querySelector('.page-header');
      if (header && !document.querySelector('.export-btn')) {
        const exportBtn = document.createElement('button');
        exportBtn.className = 'export-btn';
        exportBtn.textContent = 'Export CSV';
        exportBtn.style.cssText = `
                position: absolute;
                right: 0;
                top: 0;
                padding: 0.5rem 1rem;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.875rem;
            `;

        header.style.position = 'relative';
        header.appendChild(exportBtn);

        exportBtn.addEventListener('click', exportToCSV);
      }
    }, 200);
  });
</script>
{% endblock %}