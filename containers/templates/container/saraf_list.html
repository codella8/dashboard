{% extends 'container/container_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Almuqbil | Saraf Management{% endblock %}

{% block content %}
<div class="saraf-manager">
  <!-- Header Section -->
  <header class="manager-header">
    <div class="header-content">
      <div class="header-title">
        <h1>
          <span class="title-main">Saraf Management</span>
          <span class="title-sub">Financial accounts and transactions overview</span>
        </h1>
      </div>

      <div class="header-actions">
        <div class="action-group">
          <a href="{% url 'admin:containers_saraf_add' %}" class="action-btn primary-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" />
            </svg>
            Add Saraf
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon total">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" />
          <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" />
          <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-details">
        <span class="stat-value">{{ total_count }}</span>
        <span class="stat-label">Total Sarafs</span>
      </div>
    </div>

    <div class="stat-card highlight">
      <div class="stat-icon revenue">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 1 0 0 7h5a3.5 3.5 0 1 1 0 7H6" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-details">
        <span class="stat-value">AED {{ total_received_sum|floatformat:0|intcomma }}</span>
        <span class="stat-label">Total Received</span>
      </div>
    </div>

    <div class="stat-card highlight">
      <div class="stat-icon expenses">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 1 0 0 7h5a3.5 3.5 0 1 1 0 7H6" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-details">
        <span class="stat-value">AED {{ total_paid_sum|floatformat:0|intcomma }}</span>
        <span class="stat-label">Total Paid</span>
      </div>
    </div>

    <div class="stat-card highlight">
      <div class="stat-icon balance">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 1 0 0 7h5a3.5 3.5 0 1 1 0 7H6" stroke="currentColor" stroke-width="2" />
        </svg>
      </div>
      <div class="stat-details">
        <span class="stat-value {% if net_balance_sum > 0 %}positive{% elif net_balance_sum < 0 %}negative{% endif %}">
          AED {{ net_balance_sum|floatformat:0|intcomma }}
        </span>
        <span class="stat-label">Net Balance</span>
        <span
          class="stat-status {% if net_balance_sum > 0 %}positive{% elif net_balance_sum < 0 %}negative{% else %}neutral{% endif %}">
          {% if net_balance_sum > 0 %}Company is Creditor{% elif net_balance_sum < 0 %}Company is Debtor{% else%}Perfectly Balanced{% endif %} </span>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="controls-section">
    <div class="search-container">
      <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" />
        <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" />
      </svg>
      <input type="text" class="search-input" id="saraf-search" placeholder="Search sarafs by name, phone, or email..."
        aria-label="Search sarafs" value="{{ request.GET.search|default:'' }}">
    </div>
  </div>

  <!-- Sarafs Table -->
  <div class="sarafs-table">
    <div class="table-header">
      <div class="header-content">
        <h3 class="table-title">Sarafs List</h3>
        <div class="table-info">
          <span class="items-count">
            Showing {{ sarafs.start_index|default:1 }}-{{ sarafs.end_index|default:sarafs|length }} of {{sarafs.paginator.count }} sarafs
          </span>
        </div>
      </div>
    </div>

    <div class="table-container">
      {% if sarafs %}
      <table class="data-table">
        <thead>
          <tr>
            <th class="sarafs-info">Saraf Information</th>
            <th class="financial-info">Financial Summary</th>
            <th class="status-info">Status</th>
            <th class="actions-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for saraf in sarafs %}
          <tr class="saraf-row" data-id="{{ saraf.id }}">
            <!-- Saraf Information Column -->
            <td class="saraf-info-cell">
              <div class="saraf-identity">
                <div class="avatar">
                  {% if saraf.user and saraf.user.user %}
                  <span class="avatar-initials">
                    {{ saraf.user.user.first_name|first }}{{ saraf.user.user.last_name|first }}
                  </span>
                  {% endif %}
                </div>
                <div class="saraf-details">
                  <h4 class="saraf-name">
                    {{ saraf.user.get_full_name|default:saraf.user|default:"Unknown Saraf" }}
                  </h4>
                  <div class="saraf-meta">
                    {% if saraf.user and saraf.user.company %}
                    <span class="company-badge">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor"
                          stroke-width="2" />
                      </svg>
                      {{ saraf.user.company.name }}
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </td>

            <!-- Financial Summary Column -->
            <td class="financial-cell">
              <div class="financial-summary">
                <div class="amount-group">
                  <div class="amount-item">
                    <span class="amount-label">Received</span>
                    <span class="amount-value positive">
                      AED {{ saraf.total_received|floatformat:0|intcomma }}
                    </span>
                  </div>
                  <div class="amount-item">
                    <span class="amount-label">Paid</span>
                    <span class="amount-value negative">
                      AED {{ saraf.total_paid|floatformat:0|intcomma }}
                    </span>
                  </div>
                  <div class="amount-item highlight">
                    <span class="amount-label">Balance</span>
                    <span
                      class="amount-value {% if saraf.balance > 0 %}positive{% elif saraf.balance < 0 %}negative{% else %}neutral{% endif %}">
                      AED {{ saraf.balance|floatformat:0|intcomma }}
                    </span>
                  </div>
                </div>
                <div class="transaction-meta">
                  {% if saraf.transactions.exists %}
                  <span class="transaction-count">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                      <path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" />
                    </svg>
                    {{ saraf.transactions.count }} transactions
                  </span>
                  {% endif %}
                </div>
              </div>
            </td>

            <!-- Status Column -->
            <td class="status-cell">
              <div class="status-info">
                <div class="status-badge {% if saraf.is_active %}active{% else %}inactive{% endif %}">
                  {% if saraf.is_active %}
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                    <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" />
                  </svg>
                  Active
                  {% else %}
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6l12 18" stroke="currentColor" stroke-width="2" />
                  </svg>
                  Inactive
                  {% endif %}
                </div>

                <div class="date-info">
                  <small class="created-date">
                    Created: {{ saraf.created_at|date:"M d, Y" }}
                  </small>
                </div>
              </div>
            </td>

            <!-- Actions Column -->
            <td class="actions-cell">
              <div class="action-buttons">
                <a href="{% url 'containers:saraf_detail' saraf.id %}" class="action-btn view-btn" title="View Details">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" />
                  </svg>
                  <span>Details</span>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <!-- Empty State -->
      <div class="empty-state">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" stroke="currentColor" stroke-width="1.5" />
            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="1.5" />
            <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="1.5" />
          </svg>
        </div>
        <h3 class="empty-title">No Sarafs Found</h3>
        <p class="empty-message">
          You haven't added any sarafs yet. Start by creating your first saraf account.
        </p>
        <a href="{% url 'admin:containers_saraf_add' %}" class="empty-action-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" />
          </svg>
          Add First Saraf
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Pagination -->
    {% if sarafs.has_other_pages %}
    <div class="pagination-container">
      <div class="pagination-info">
        <span>Page {{ sarafs.number }} of {{ sarafs.paginator.num_pages }}</span>
      </div>

      <div class="pagination-controls">
        {% if sarafs.has_previous %}
        <a href="?page={{ sarafs.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
          class="page-nav prev">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" />
          </svg>
          Previous
        </a>
        {% endif %}

        <div class="page-numbers">
          {% for num in sarafs.paginator.page_range %}
          {% if sarafs.number == num %}
          <span class="page-number active">{{ num }}</span>
          {% elif num > sarafs.number|add:'-3' and num < sarafs.number|add:'3' %} <a
            href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
            class="page-number">{{ num }}</a>
            {% endif %}
            {% endfor %}
        </div>

        {% if sarafs.has_next %}
        <a href="?page={{ sarafs.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
          class="page-nav next">
          Next
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" />
          </svg>
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" hidden>
  <div class="spinner"></div>
  <span>Loading sarafs...</span>
</div>

<!-- Confirmation Modal Template -->
<template id="confirmation-modal">
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 class="modal-title">Confirm Action</h3>
      <p class="modal-message">Are you sure you want to perform this action?</p>
      <div class="modal-actions">
        <button class="modal-btn cancel">Cancel</button>
        <button class="modal-btn confirm">Confirm</button>
      </div>
    </div>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Search functionality
    const searchInput = document.getElementById('saraf-search');
    const searchForm = document.createElement('form');
    searchForm.method = 'GET';
    searchForm.style.display = 'none';

    // Add search parameter to form
    if (searchInput) {
      searchInput.addEventListener('input', function (e) {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          const searchValue = this.value.trim();
          const url = new URL(window.location.href);

          if (searchValue) {
            url.searchParams.set('search', searchValue);
          } else {
            url.searchParams.delete('search');
          }

          // Reset to page 1 when searching
          url.searchParams.delete('page');
          window.location.href = url.toString();
        }, 500); // 500ms debounce
      });
    }
  });
</script>
{% endblock %}