{% extends 'employee/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Almuqbil | Employee Details{% endblock %}

{% block content %}
<div class="employee-detail-container">
    <div class="detail-header">
        <a href="{% url 'employee:employee_list' %}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Employees
        </a>
        <div class="header-actions">
            <a href="{% url 'admin:employees_employee_change' employee.id %}" class="btn-edit">
                <i class="fas fa-edit"></i>
                Edit
            </a>
            <a href="{% url 'employee:process_salary_payment' %}?employee={{ employee.id }}" class="btn-primary">
                <i class="fas fa-money-bill-wave"></i>
                Payment
            </a>
        </div>
    </div>
    <div class="profile-header">
        <div class="profile-avatar">
            <div class="avatar-large">
                {% if employee.employee and employee.employee.user %}
                    {{ employee.employee.user.first_name|first|upper }}{{ employee.employee.user.last_name|first|upper }}
                {% else %}
                    ?
                {% endif %}
            </div>
        </div>
        <div class="profile-info">
            <h1>{{ employee_info.full_name }}</h1>
            <div class="profile-meta">
                <span class="position">
                    <i class="fas fa-briefcase"></i>
                    {{ employee_info.position }}
                </span>
                <span class="department">
                    <i class="fas fa-building"></i>
                    {{ employee_info.department }}
                </span>
                <span class="employee-id">
                    <i class="fas fa-id-card"></i>
                    ID: {{ employee.id|slice:":8" }}
                </span>
            </div>
            <div class="profile-status">
                <span class="status-badge status-active">
                    <i class="fas fa-circle"></i>
                    {{ employee_info.status }}
                </span>
                <span class="employment-type">
                    {{ employee_info.employment_type }}
                </span>
            </div>
        </div>
        <div class="profile-stats">
            <div class="stat-item">
                <div class="stat-label">Years of Service</div>
                <div class="stat-value">
                    {% if employee_info.years_of_service %}
                        {{ employee_info.years_of_service }} years
                        {% if employee_info.months_of_service %}
                            {{ employee_info.months_of_service }} months
                        {% endif %}
                    {% else %}
                        Not specified
                    {% endif %}
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Hire Date</div>
                <div class="stat-value">
                    {% if employee_info.hire_date %}
                        {{ employee_info.hire_date|date:"F d, Y" }}
                    {% else %}
                        Not specified
                    {% endif %}
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Email</div>
                <div class="stat-value">{{ employee_info.email|default:"Not specified" }}</div>
            </div>
        </div>
    </div>
    <div class="section financial-overview">
        <div class="section-header">
            <h2>
                <i class="fas fa-chart-pie"></i>
                Financial Overview
            </h2>
            <span class="payment-status status-{{ payment_status.label|slugify }}">
                <i class="fas fa-{{ payment_status.icon }}"></i>
                {{ payment_status.label }}
            </span>
        </div>
        
        <div class="financial-grid">
            <!-- Salary Summary -->
            <div class="financial-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3>Salary Summary</h3>
                </div>
                <div class="card-body">
                    <div class="financial-item">
                        <span class="label">Monthly Salary</span>
                        <span class="value">${{ employee.salary_due|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="financial-item">
                        <span class="label">Total Paid</span>
                        <span class="value">${{ financials.total_paid|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="financial-item">
                        <span class="label">Total Expenses</span>
                        <span class="value">${{ financials.total_expenses|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="financial-item">
                        <span class="label">Company Debt</span>
                        <span class="value">${{ financials.debt_to_company|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="financial-item highlight">
                        <span class="label">Remaining Balance</span>
                        <span class="value">${{ financials.remaining_balance|floatformat:0|intcomma }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Payment Progress -->
            <div class="financial-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>Payment Progress</h3>
                </div>
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Paid: {{ financials.payment_percentage }}%</span>
                            <span>${{ financials.total_paid|floatformat:0|intcomma }} of ${{ employee.salary_due|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="progress-bar large">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat">
                            <div class="stat-label">Average Monthly</div>
                            <div class="stat-value">${{ financials.avg_monthly|floatformat:0|intcomma }}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Last Payment</div>
                            <div class="stat-value">
                                {% if financials.last_payment %}
                                    {{ financials.last_payment.date|date:"M d, Y" }}
                                {% else %}
                                    Never
                                {% endif %}
                            </div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Financial Health</div>
                            <div class="stat-value status-{{ financials.financial_health }}">
                                {{ financials.financial_health|title }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="financial-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h3>Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div class="action-list">
                        <a href="{% url 'employee:process_salary_payment' %}?employee={{ employee.id }}" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="action-content">
                                <h4>Process Payment</h4>
                                <p>Pay outstanding balance</p>
                            </div>
                        </a>
                        <a href="#" class="action-item" onclick="window.print()">
                            <div class="action-icon">
                                <i class="fas fa-print"></i>
                            </div>
                            <div class="action-content">
                                <h4>Print Report</h4>
                                <p>Generate printable report</p>
                            </div>
                        </a>
                        <a href="{% url 'admin:employees_employee_change' employee.id %}" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-content">
                                <h4>Edit Profile</h4>
                                <p>Update employee information</p>
                            </div>
                        </a>
                        <a href="mailto:{{ employee_info.email }}" class="action-item">
                            <div class="action-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="action-content">
                                <h4>Send Email</h4>
                                <p>Contact employee</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    <div class="section payment-history">
        <div class="section-header">
            <h2>
                <i class="fas fa-history"></i>
                Payment History
            </h2>
            <div class="section-stats">
                <span class="stat">
                    <i class="fas fa-check-circle"></i>
                    {{ payment_stats.paid_count }} paid
                </span>
                <span class="stat">
                    <i class="fas fa-clock"></i>
                    {{ payment_stats.pending_count }} pending
                </span>
                <span class="stat">
                    <i class="fas fa-money-bill-wave"></i>
                    ${{ payment_stats.total_paid_amount|floatformat:0|intcomma }} total
                </span>
            </div>
        </div>
        
        {% if salary_payments %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Payment Method</th>
                        <th>Reference</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in salary_payments %}
                    <tr>
                        <td>{{ payment.date|date:"Y-m-d" }}</td>
                        <td class="amount">${{ payment.salary_amount|floatformat:0|intcomma }}</td>
                        <td>
                            <span class="payment-method">
                                {{ payment.get_payment_method_display }}
                            </span>
                        </td>
                        <td>
                            {% if payment.reference_number %}
                            <span class="reference">{{ payment.reference_number }}</span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if payment.is_paid %}
                            <span class="status-badge status-paid">
                                <i class="fas fa-check-circle"></i>
                                Paid
                            </span>
                            {% else %}
                            <span class="status-badge status-pending">
                                <i class="fas fa-clock"></i>
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="notes">{{ payment.note|truncatechars:30|default:"—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if salary_payments|length > 20 %}
        <div class="view-all">
            <a href="#" class="btn-secondary">View All Payments</a>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <i class="fas fa-money-bill-wave"></i>
            <h3>No Payment History</h3>
            <p>No payments have been recorded for this employee yet.</p>
            <a href="{% url 'employee:process_salary_payment' %}?employee={{ employee.id }}" class="btn-primary">
                <i class="fas fa-plus"></i>
                Record First Payment
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Expense History -->
    <div class="section expense-history">
        <div class="section-header">
            <h2>
                <i class="fas fa-receipt"></i>
                Expense History
            </h2>
            <div class="section-stats">
                <span class="stat">
                    <i class="fas fa-list"></i>
                    {{ expense_stats.total_expenses }} expenses
                </span>
                <span class="stat">
                    <i class="fas fa-money-bill-wave"></i>
                    ${{ expense_stats.total_amount|floatformat:0|intcomma }} total
                </span>
            </div>
        </div>
        
        {% if expense_stats.by_category %}
        <div class="category-breakdown">
            <h4>Expense Categories</h4>
            <div class="category-grid">
                {% for category in expense_stats.by_category %}
                <div class="category-item">
                    <div class="category-header">
                        <span class="category-name">{{ category.get_category_display }}</span>
                        <span class="category-amount">${{ category.total|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="category-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" ></div>
                        </div>
                        <div class="category-count">{{ category.count }} items</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if expenses %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Expense</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td>{{ expense.date|date:"Y-m-d" }}</td>
                        <td>{{ expense.expense }}</td>
                        <td>
                            <span class="category-badge">
                                {{ expense.get_category_display }}
                            </span>
                        </td>
                        <td class="amount">${{ expense.price|floatformat:0|intcomma }}</td>
                        <td class="notes">{{ expense.note|truncatechars:30|default:"—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if expenses|length > 20 %}
        <div class="view-all">
            <a href="#" class="btn-secondary">View All Expenses</a>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <i class="fas fa-receipt"></i>
            <h3>No Expenses Recorded</h3>
            <p>No expenses have been recorded for this employee yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Activity -->
    <div class="section recent-activity">
        <div class="section-header">
            <h2>
                <i class="fas fa-bell"></i>
                Recent Activity
            </h2>
        </div>
        
        <div class="activity-timeline">
            {% if recent_payments %}
            {% for payment in recent_payments %}
            <div class="activity-item">
                <div class="activity-icon payment">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-header">
                        <h4>Salary Payment</h4>
                        <span class="activity-time">{{ payment.date|date:"F d, Y" }}</span>
                    </div>
                    <p>Payment of ${{ payment.salary_amount|floatformat:0|intcomma }} {% if payment.is_paid %}completed{% else %}pending{% endif %}</p>
                    {% if payment.note %}
                    <div class="activity-note">{{ payment.note }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if recent_expenses %}
            {% for expense in recent_expenses %}
            <div class="activity-item">
                <div class="activity-icon expense">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-header">
                        <h4>Expense Recorded</h4>
                        <span class="activity-time">{{ expense.date|date:"F d, Y" }}</span>
                    </div>
                    <p>{{ expense.expense }} - ${{ expense.price|floatformat:0|intcomma }}</p>
                    {% if expense.note %}
                    <div class="activity-note">{{ expense.note }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if not recent_payments and not recent_expenses %}
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <p>No recent activity recorded</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Payment Trend -->
    {% if payment_trend_data %}
    <div class="section payment-trend">
        <div class="section-header">
            <h2>
                <i class="fas fa-chart-line"></i>
                Payment Trend (12 Months)
            </h2>
        </div>
        
        <div class="trend-container">
            <div class="trend-bars">
                {% for month in payment_trend_data %}
                <div class="trend-bar">
                    <div class="bar-label">{{ month.month }}</div>
                    <div class="bar-container">
                        <div class="bar"></div>
                    </div>
                    <div class="bar-value">${{ month.amount|floatformat:0|intcomma }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Notes Section -->
    {% if employee_info.notes %}
    <div class="section notes-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-sticky-note"></i>
                Notes
            </h2>
        </div>
        
        <div class="notes-content">
            {{ employee_info.notes|linebreaks }}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple JavaScript for employee detail page
document.addEventListener('DOMContentLoaded', function() {
    // Add loading state to buttons
    const buttons = document.querySelectorAll('a.btn-primary, a.btn-secondary');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            if (!this.classList.contains('disabled')) {
                this.classList.add('loading');
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            }
        });
    });
    
    // Print functionality
    window.printReport = function() {
        window.print();
    };
    
    // Toggle sections for mobile
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
        header.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                const section = this.closest('.section');
                section.classList.toggle('collapsed');
            }
        });
    });
    
    // Format currency on page
    const currencyElements = document.querySelectorAll('.amount');
    currencyElements.forEach(el => {
        const amount = parseFloat(el.textContent.replace('$', '').replace(/,/g, ''));
        if (!isNaN(amount)) {
            el.textContent = '$' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
    });
});
</script>
{% endblock %}