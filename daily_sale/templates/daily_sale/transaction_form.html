{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}

{% block title %}{{ title }} - Inventory System{% endblock %}

{% block extra_css %}
<style>

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-12">
            <!-- Header Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="{% url 'daily_sale:transaction_list' %}">Transactions</a></li>
                                    <li class="breadcrumb-item active">{{ title }}</li>
                                </ol>
                            </nav>
                        </div>
                        <div class="col-auto">
                            <a href="{% url 'daily_sale:transaction_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="card border-0 shadow-sm form-card">
                <div class="card-header bg-white py-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0">{{ title }}</h4>
                            <p class="text-muted mb-0">All financial calculations are automated</p>
                        </div>
                        <div class="col-auto">
                            {% if transaction %}
                            <span class="badge bg-primary">Invoice: {{ transaction.invoice_number }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <form method="post" id="transaction-form">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">üìã Basic Information</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Invoice Number *</label>
                                {{ form.invoice_number }}
                                {% if form.invoice_number.errors %}
                                <div class="text-danger small">{{ form.invoice_number.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Date *</label>
                                {{ form.date }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Currency *</label>
                                {{ form.currency }}
                            </div>
                        </div>

                        <!-- Transaction Details -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">üí∞ Transaction Details</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Transaction Type *</label>
                                {{ form.transaction_type }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Status *</label>
                                {{ form.status }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Item/Product</label>
                                {{ form.item }}
                            </div>
                        </div>

                        <!-- Financial Inputs -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">üíµ Financial Inputs</h6>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Quantity *</label>
                                {{ form.quantity }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Unit Price *</label>
                                {{ form.unit_price }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Advance Payment</label>
                                {{ form.advance }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Discount</label>
                                {{ form.discount }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tax Amount</label>
                                {{ form.tax }}
                            </div>
                        </div>

                        <!-- Auto-calculated Fields -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">üßÆ Auto-calculated Fields</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Subtotal</label>
                                <div class="calculated-field" id="subtotal-display">$0.00</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Total Amount</label>
                                <div class="calculated-field" id="total-amount-display">$0.00</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Balance</label>
                                <div class="calculated-field" id="balance-display">$0.00</div>
                            </div>
                        </div>

                        <!-- Related Parties -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">üë• Related Parties</h6>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Customer</label>
                                {{ form.customer }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Company</label>
                                {{ form.company }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Container</label>
                                {{ form.container }}
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">üìù Additional Information</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Description</label>
                                {{ form.description }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Notes</label>
                                {{ form.note }}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2 justify-content-end">
                                    <a href="{% url 'daily_sale:transaction_list' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        {% if transaction %}Update Transaction{% else %}Create Transaction{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body">
                    <h6><i class="fas fa-info-circle me-2 text-primary"></i>Smart Calculation Guide</h6>
                    <ul class="mb-0">
                        <li>Subtotal = Quantity √ó Unit Price</li>
                        <li>Total Amount = (Subtotal - Discount) + Tax</li>
                        <li>Balance = Total Amount - Advance Payment</li>
                        <li>All calculations update automatically</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time Calculation
function calculateFinancials() {
    const quantity = parseFloat(document.getElementById('id_quantity').value) || 0;
    const unitPrice = parseFloat(document.getElementById('id_unit_price').value) || 0;
    const discount = parseFloat(document.getElementById('id_discount').value) || 0;
    const tax = parseFloat(document.getElementById('id_tax').value) || 0;
    const advance = parseFloat(document.getElementById('id_advance').value) || 0;

    // Calculations
    const subtotal = quantity * unitPrice;
    const totalAmount = Math.max(0, subtotal - discount) + tax;
    const balance = Math.max(0, totalAmount - advance);

    // Update displays
    document.getElementById('subtotal-display').textContent = '$' + subtotal.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    document.getElementById('total-amount-display').textContent = '$' + totalAmount.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    document.getElementById('balance-display').textContent = '$' + balance.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Add event listeners to input fields
['id_quantity', 'id_unit_price', 'id_discount', 'id_tax', 'id_advance'].forEach(id => {
    document.getElementById(id).addEventListener('input', calculateFinancials);
});

// Initial calculation
document.addEventListener('DOMContentLoaded', calculateFinancials);

// Form validation
document.getElementById('transaction-form').addEventListener('submit', function(e) {
    const quantity = parseFloat(document.getElementById('id_quantity').value);
    const unitPrice = parseFloat(document.getElementById('id_unit_price').value);
    
    if (quantity <= 0) {
        e.preventDefault();
        alert('Quantity must be greater than 0.');
        return;
    }
    
    if (unitPrice < 0) {
        e.preventDefault();
        alert('Unit price cannot be negative.');
        return;
    }
});
</script>
{% endblock %}