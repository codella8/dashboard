{% extends "daily_sale/daily_sale_base.html" %}
{% load humanize %}

{% block title %}Almuqbil | cleared_transactions{% endblock %}

{% block content %}
<div class="dashboard-content">
    <!-- Header Section -->
    <div class="dashboard-header-section">
        <div class="header-left">
            <h1 class="dashboard-title">
                <i class="bi bi-check-circle-fill text-success"></i>
                Cleared & Paid Transactions
            </h1>
            <p class="dashboard-subtitle">
                <i class="bi bi-info-circle"></i>
                Fully settled transactions with zero balance
            </p>
        </div>
        <div class="header-actions">
            <div class="date-selector">
                <select class="form-select" id="periodSelect">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <button class="btn-refresh" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
            </button>
            <button class="btn-export" onclick="exportClearedTransactions()">
                <i class="bi bi-download"></i>
                Export
            </button>
        </div>
    </div>

    <!-- Stats Cards for Cleared Transactions -->
    <div class="stats-grid">
        <!-- Total Cleared Amount -->
        <div class="stat-card card-success">
            <div class="stat-card-header">
                <div class="stat-icon">
                    <i class="bi bi-cash-stack text-success"></i>
                </div>
                <h3>Total Cleared</h3>
            </div>
            <div class="stat-card-value">
                ${{ cleared_stats.total_amount|floatformat:0|intcomma }}
            </div>
            <div class="stat-card-details">
                <span class="stat-badge">{{ cleared_stats.transaction_count }} transactions</span>
                <span class="stat-change">
                    <i class="bi bi-arrow-up-right"></i>
                    {{ cleared_stats.percentage_of_total|floatformat:1 }}% of all transactions
                </span>
            </div>
        </div>

        <!-- Average Settlement Time -->
        <div class="stat-card card-info">
            <div class="stat-card-header">
                <div class="stat-icon">
                    <i class="bi bi-clock-history text-info"></i>
                </div>
                <h3>Avg. Settlement</h3>
            </div>
            <div class="stat-card-value">
                {{ cleared_stats.avg_settlement_days|floatformat:1 }} days
            </div>
            <div class="stat-card-details">
                <span class="stat-badge">{{ cleared_stats.immediate_settlements }} immediate</span>
                <span class="stat-change">
                    <i class="bi bi-graph-down"></i>
                    {{ cleared_stats.avg_discount|floatformat:1 }}% avg discount
                </span>
            </div>
        </div>

        <!-- Top Customer -->
        <div class="stat-card card-warning">
            <div class="stat-card-header">
                <div class="stat-icon">
                    <i class="bi bi-person-check text-warning"></i>
                </div>
                <h3>Top Customer</h3>
            </div>
            <div class="stat-card-value">
                {{ cleared_stats.top_customer.name|truncatechars:15|default:"N/A" }}
            </div>
            <div class="stat-card-details">
                <span class="stat-badge">${{ cleared_stats.top_customer.amount|floatformat:0|intcomma }}</span>
                <span class="stat-change">
                    <i class="bi bi-receipt"></i>
                    {{ cleared_stats.top_customer.count }} transactions
                </span>
            </div>
        </div>

        <!-- Quick Settlement -->
        <div class="stat-card card-primary">
            <div class="stat-card-header">
                <div class="stat-icon">
                    <i class="bi bi-lightning-charge text-primary"></i>
                </div>
                <h3>Quick Settled</h3>
            </div>
            <div class="stat-card-value">
                {{ cleared_stats.quick_settlements }}
            </div>
            <div class="stat-card-details">
                <span class="stat-badge">< 7 days</span>
                <span class="stat-change">
                    <i class="bi bi-arrow-up-right"></i>
                    {{ cleared_stats.quick_settlement_rate|floatformat:1 }}% rate
                </span>
            </div>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Customer:</label>
            <select class="form-select filter-select" id="customerFilter">
                <option value="">All Customers</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>Payment Method:</label>
            <select class="form-select filter-select" id="paymentMethodFilter">
                <option value="">All Methods</option>
                <option value="cash">Cash</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="check">Check</option>
                <option value="credit_card">Credit Card</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Settlement Type:</label>
            <select class="form-select filter-select" id="settlementTypeFilter">
                <option value="">All Types</option>
                <option value="full">Full Payment</option>
                <option value="partial">Partial Payments</option>
                <option value="advance">Advance Payment</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Sort By:</label>
            <select class="form-select filter-select" id="sortByFilter">
                <option value="date_desc">Date (Newest)</option>
                <option value="date_asc">Date (Oldest)</option>
                <option value="amount_desc">Amount (High to Low)</option>
                <option value="amount_asc">Amount (Low to High)</option>
                <option value="settlement_desc">Settlement Days</option>
            </select>
        </div>
        
        <button class="btn-clear-filters" onclick="clearFilters()">
            <i class="bi bi-x-circle"></i>
            Clear Filters
        </button>
    </div>

    <!-- Cleared Transactions Table -->
    <div class="content-card">
        <div class="card-header">
            <h2>
                <i class="bi bi-list-check text-success"></i>
                Cleared Transactions List
                <span class="badge bg-success">{{ paginator.count }}</span>
            </h2>
            <div class="card-actions">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search invoice, customer, item..." id="searchInput">
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table transactions-table">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th>Invoice Details</th>
                        <th>Customer</th>
                        <th>Transaction Details</th>
                        <th class="text-end">Financials</th>
                        <th>Settlement Info</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in cleared_transactions %}
                    <tr class="transaction-row {% if transaction.is_recent %}new-row{% endif %}">
                        <!-- Serial Number -->
                        <td class="text-center">
                            <span class="serial-number">{{ forloop.counter0|add:page_obj.start_index }}</span>
                        </td>
                        
                        <!-- Invoice Details -->
                        <td>
                            <div class="invoice-info">
                                <strong class="invoice-number">
                                    <i class="bi bi-receipt"></i>
                                    {{ transaction.invoice_number }}
                                </strong>
                                <div class="invoice-meta">
                                    <span class="badge bg-secondary">{{ transaction.date|date:"M d, Y" }}</span>
                                    {% if transaction.due_date %}
                                    <span class="text-muted">Due: {{ transaction.due_date|date:"M d" }}</span>
                                    {% endif %}
                                </div>
                                {% if transaction.description %}
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-chat-left"></i>
                                    {{ transaction.description|truncatechars:50 }}
                                </small>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Customer Info -->
                        <td>
                            <div class="customer-info">
                                <div class="customer-avatar bg-success">
                                    {{ transaction.customer.initials|default:"C" }}
                                </div>
                                <div class="customer-details">
                                    <strong>{{ transaction.customer.name|default:"Unknown Customer" }}</strong>
                                    <div class="customer-contact">
                                        {% if transaction.customer.phone %}
                                        <small><i class="bi bi-telephone"></i> {{ transaction.customer.phone }}</small>
                                        {% endif %}
                                        {% if transaction.customer.email %}
                                        <small><i class="bi bi-envelope"></i> {{ transaction.customer.email|truncatechars:20 }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Transaction Details -->
                        <td>
                            <div class="transaction-details">
                                <div class="item-info">
                                    <strong>
                                        <i class="bi bi-box"></i>
                                        {{ transaction.item.name|truncatechars:25|default:"N/A" }}
                                    </strong>
                                    <small class="text-muted d-block">
                                        Qty: {{ transaction.quantity }} Ã— ${{ transaction.unit_price|floatformat:2 }}
                                    </small>
                                </div>
                                {% if transaction.container %}
                                <div class="container-info mt-1">
                                    <small>
                                        <i class="bi bi-archive"></i>
                                        Container: {{ transaction.container.name|truncatechars:20 }}
                                    </small>
                                </div>
                                {% endif %}
                                <div class="transaction-type mt-1">
                                    <span class="badge {% if transaction.transaction_type == 'sale' %}bg-success{% else %}bg-primary{% endif %}">
                                        {{ transaction.transaction_type|title }}
                                    </span>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Financials -->
                        <td class="text-end">
                            <div class="financials">
                                <div class="amount-row">
                                    <span class="label">Total:</span>
                                    <span class="value">${{ transaction.total_amount|floatformat:2|intcomma }}</span>
                                </div>
                                <div class="amount-row text-success">
                                    <span class="label">Paid:</span>
                                    <span class="value">${{ transaction.paid_amount|floatformat:2|intcomma }}</span>
                                </div>
                                {% if transaction.discount > 0 %}
                                <div class="amount-row text-warning">
                                    <span class="label">Discount:</span>
                                    <span class="value">${{ transaction.discount|floatformat:2|intcomma }}</span>
                                </div>
                                {% endif %}
                                {% if transaction.advance > 0 %}
                                <div class="amount-row text-info">
                                    <span class="label">Advance:</span>
                                    <span class="value">${{ transaction.advance|floatformat:2|intcomma }}</span>
                                </div>
                                {% endif %}
                                <div class="amount-row">
                                    <span class="label">Tax:</span>
                                    <span class="value">${{ transaction.tax|floatformat:2|intcomma }}</span>
                                </div>
                                <div class="final-balance text-success">
                                    <strong>Balance: $0.00</strong>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Settlement Info -->
                        <td>
                            <div class="settlement-info">
                                <div class="settlement-status">
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i>
                                        Fully Cleared
                                    </span>
                                </div>
                                <div class="settlement-details mt-2">
                                    <small class="d-block">
                                        <i class="bi bi-calendar-check"></i>
                                        Settled: {{ transaction.settlement_date|date:"M d, Y"|default:"N/A" }}
                                    </small>
                                    <small class="d-block">
                                        <i class="bi bi-clock-history"></i>
                                        Days to settle: {{ transaction.days_to_settle|default:"0" }}
                                    </small>
                                    {% if transaction.last_payment_method %}
                                    <small class="d-block">
                                        <i class="bi bi-credit-card"></i>
                                        Method: {{ transaction.last_payment_method }}
                                    </small>
                                    {% endif %}
                                    <small class="d-block">
                                        <i class="bi bi-cash-coin"></i>
                                        Payments: {{ transaction.payment_count }}
                                    </small>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Actions -->
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn-action btn-view" 
                                        onclick="viewTransaction('{{ transaction.id }}')"
                                        title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn-action btn-print" 
                                        onclick="printInvoice('{{ transaction.id }}')"
                                        title="Print Invoice">
                                    <i class="bi bi-printer"></i>
                                </button>
                                <button class="btn-action btn-receipt" 
                                        onclick="downloadReceipt('{{ transaction.id }}')"
                                        title="Download Receipt">
                                    <i class="bi bi-receipt"></i>
                                </button>
                                <div class="dropdown">
                                    <button class="btn-action btn-more dropdown-toggle" 
                                            type="button" 
                                            data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="#" 
                                               onclick="sendReceiptEmail('{{ transaction.id }}')">
                                                <i class="bi bi-envelope me-2"></i>Email Receipt
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" 
                                               onclick="duplicateTransaction('{{ transaction.id }}')">
                                                <i class="bi bi-copy me-2"></i>Duplicate
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" 
                                               onclick="voidTransaction('{{ transaction.id }}')">
                                                <i class="bi bi-x-circle me-2"></i>Void Transaction
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="empty-state">
                                <i class="bi bi-check-circle display-1 text-success"></i>
                                <h3 class="mt-3">No Cleared Transactions</h3>
                                <p class="text-muted">All transactions are either pending or have outstanding balance</p>
                                <a href="{% url 'daily_sale:transaction_list' %}" class="btn btn-primary mt-2">
                                    <i class="bi bi-receipt me-2"></i>
                                    View All Transactions
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if paginator.num_pages > 1 %}
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ paginator.num_pages }}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <div class="text-center text-muted mt-2">
                    Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} cleared transactions
                </div>
            </nav>
        </div>
        {% endif %}
    </div>
    
    <!-- Summary Section -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="content-card">
                <div class="card-header">
                    <h4><i class="bi bi-pie-chart me-2"></i>Settlement Analysis</h4>
                </div>
                <div class="card-body">
                    <canvas id="settlementChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="content-card">
                <div class="card-header">
                    <h4><i class="bi bi-bar-chart me-2"></i>Cleared Amount Trend</h4>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetails">
                <!-- Loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

