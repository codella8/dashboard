{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Almuqbil | Cleared Transactions {% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2 text-gray-800">
                <i class="fas fa-check-circle text-success me-2"></i>
                Cleared Transactions
            </h1>
            <p class="text-muted mb-0">
                <i class="fas fa-chart-line me-1"></i>
                Comprehensive financial analysis of not paid transactions
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-danger" id="refreshBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-success text-uppercase mb-2">Total Cleared Amount</h6>
                            <h2 class="mb-2">AED {{ cleared_stats.total_amount|floatformat:0|intcomma }}</h2>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2">{{ cleared_stats.total_transactions }}</span>
                                <small class="text-muted">Transactions</small>
                            </div>
                        </div>
                        <div class="text-success opacity-25">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-primary text-uppercase mb-2">Unpaid</h6>
                            <h2 class="mb-2">{{ cleared_stats.avg_days_to_settle|floatformat:1 }} days</h2>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">{{ cleared_stats.total_customers }}</span>
                                <small class="text-muted">Customers</small>
                            </div>
                        </div>
                        <div class="text-primary opacity-25">
                            <i class="fas fa-tachometer-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-info text-uppercase mb-2">Payment Types</h6>
                            <h2 class="mb-2">{{ cleared_stats.full_payments }}/{{ cleared_stats.partial_payments }}</h2>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-2">Full/Partial</span>
                            </div>
                        </div>
                        <div class="text-info opacity-25">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-warning text-uppercase mb-2">Average Transaction</h6>
                            <h2 class="mb-2">AED {{ cleared_stats.avg_amount|floatformat:0|intcomma }}</h2>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-warning me-2">Range</span>
                                <small class="text-muted">{{ cleared_stats.fastest_settle }} - {{
                                    cleared_stats.slowest_settle }} days</small>
                            </div>
                        </div>
                        <div class="text-warning opacity-25">
                            <i class="fas fa-chart-bar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Advanced Filters & Analytics
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Period</label>
                    <select class="form-select" name="period">
                        <option value="today" {% if request.GET.period == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if request.GET.period == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if request.GET.period == 'month' or not request.GET.period %}selected{% endif %}>This Month</option>
                        <option value="year" {% if request.GET.period == 'year' %}selected{% endif %}>This Year</option>
                        <option value="all" {% if request.GET.period == 'all' %}selected{% endif %}>All Time</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" name="sort">
                        <option value="date_desc" {% if request.GET.sort == 'date_desc' %}selected{% endif %}>Newest First
                        </option>
                        <option value="date_asc" {% if request.GET.sort == 'date_asc' %}selected{% endif %}>Oldest First
                        </option>
                        <option value="amount_desc" {% if request.GET.sort == 'amount_desc' %}selected{% endif %}>Highest
                            Amount</option>
                        <option value="amount_asc" {% if request.GET.sort == 'amount_asc' %}selected{% endif %}>Lowest
                            Amount</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Invoice or Customer..."
                            value="{{ search_query }}">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="card shadow">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-check me-2"></i>
                    Cleared Transactions
                </h5>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Invoice No.</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th class="text-end">Amount</th>
                            <th class="text-end">Paid</th>
                            <th>Settlement</th>
                            <th class="text-end">Days</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        {% for transaction in cleared_transactions %}
                        <tr
                            class="{% if transaction.settlement_type == 'full' %}table-success{% else %}table-info{% endif %}">
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <strong>{{ transaction.invoice_number }}</strong>
                            </td>
                            <td>{{ transaction.date|date:"Y-m-d" }}</td>
                            <td>{{ transaction.customer_name }}</td>
                            <td class="text-end">
                                <strong>AED {{ transaction.total_amount|floatformat:2|intcomma }}</strong>
                            </td>
                            <td class="text-end text-success">
                                AED {{ transaction.paid_amount|floatformat:2|intcomma }}
                            </td>
                            <td>
                                {% if transaction.settlement_date %}
                                {{ transaction.settlement_date|date:"Y-m-d" }}
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if transaction.days_to_settle > 0 %}
                                <span
                                    class="badge {% if transaction.days_to_settle <= 7 %}bg-success{% elif transaction.days_to_settle <= 30 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ transaction.days_to_settle }} days
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if transaction.settlement_type == 'full' %}
                                <span class="badge bg-success">Full</span>
                                {% else %}
                                <span class="badge bg-info">Partial ({{ transaction.payment_count }})</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary download-receipt-btn"
                                        data-transaction-id="{{ transaction.id }}">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                    <button class="btn btn-outline-info view-details-btn"
                                        data-transaction-id="{{ transaction.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{% url 'daily_sale:transaction_detail' transaction.id %}"
                                        class="btn btn-outline-secondary">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                    <h5>No Cleared Transactions Found</h5>
                                    <p>No fully paid transactions in the selected period.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="4" class="text-end">TOTALS:</th>
                            <th class="text-end">AED {{ cleared_stats.total_amount|floatformat:2|intcomma }}</th>
                            <th class="text-end text-success">AED {{ cleared_stats.total_amount|floatformat:2|intcomma }}</th>
                            <th colspan="2"></th>
                            <th>
                                {{ cleared_stats.full_payments }} Full / {{ cleared_stats.partial_payments }} Partial
                            </th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}"
                            aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item"><a
                            class="page-link" href="?page={{ num }}&{{ request.GET.urlencode|cut:'page=' }}">{{ num }}</a></li>
                        {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}"
                                aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>

    <div class="card shadow mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Financial Summary</h5>
        </div>
        <div class="card-body">
            <div class="row">
               
                <div class="col-md-6">
                    <h6>Export Options</h6>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>PDF Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="chart-data" data-transactions='{{ transactions_json|safe }}' style="display: none;">
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let transactionsData = [];

    document.addEventListener('DOMContentLoaded', function () {
        const chartDataElement = document.getElementById('chart-data');
        if (chartDataElement && chartDataElement.dataset.transactions) {
            try {
                transactionsData = JSON.parse(chartDataElement.dataset.transactions);
            } catch (e) {
                console.error('Error parsing transaction data:', e);
            }
        }

        initializeCharts();
        document.querySelectorAll('.download-receipt-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                downloadReceipt(transactionId);
            });
        });

        document.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                viewTransactionDetails(transactionId);
            });
        });

        // Auto-refresh
        let refreshInterval = setInterval(refreshData, 120000);
        let autoRefreshEnabled = true;

        // Manual refresh button
        document.getElementById('refreshBtn').addEventListener('click', function () {
            window.location.reload();
        });
            
    });

    function refreshData() {
        if (!autoRefreshEnabled) return;

        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
            refreshBtn.disabled = true;

            showNotification('Updating cleared transactions data...', 'info');

            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }
    function viewTransactionDetails(transactionId) {
        const transaction = transactionsData.find(t => t.id == transactionId);
        if (transaction) {
            const detailsContent = document.getElementById('detailsContent');
            detailsContent.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6>Transaction Information</h6>
            <table class="table table-sm">
              <tr>
                <th>Invoice Number:</th>
                <td>${transaction.invoice_number}</td>
              </tr>
              <tr>
                <th>Transaction Date:</th>
                <td>${transaction.date}</td>
              </tr>
              <tr>
                <th>Customer:</th>
                <td>${transaction.customer_name}</td>
              </tr>
              <tr>
                <th>Total Amount:</th>
                <td class="text-success">AED ${transaction.total_amount.toFixed(2)}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6>Settlement Details</h6>
            <table class="table table-sm">
              <tr>
                <th>Settlement Type:</th>
                <td>
                  <span class="badge ${transaction.settlement_type === 'full' ? 'bg-success' : 'bg-info'}">
                    ${transaction.settlement_type === 'full' ? 'Full Payment' : 'Partial Payments'}
                  </span>
                </td>
              </tr>
              <tr>
                <th>Number of Payments:</th>
                <td>${transaction.payment_count || 1}</td>
              </tr>
              <tr>
                <th>Days to Settle:</th>
                <td>
                  <span class="badge ${transaction.days_to_settle <= 7 ? 'bg-success' : transaction.days_to_settle <= 30 ? 'bg-warning' : 'bg-danger'}">
                    ${transaction.days_to_settle} days
                  </span>
                </td>
              </tr>
              <tr>
                <th>Settlement Date:</th>
                <td>${transaction.settlement_date || 'N/A'}</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="mt-3">
          <h6>Payment History</h6>
          <p class="text-muted">Payment history would be displayed here in real implementation.</p>
        </div>
      `;
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        } else {
            showNotification('Transaction details not found', 'danger');
        }
    }
    function exportToPDF() {
        const url = new URL(window.location.href);
        url.searchParams.set('export', 'pdf');
        window.open(url.toString(), '_blank');
    }

    function viewAnalytics() {
        window.open("{% url 'daily_sale:cleared_transactions' %}?analytics=true", '_blank');
    }

    function initializeCharts() {
        if (transactionsData.length === 0) return;

        const settlementCtx = document.getElementById('settlementChart');
        if (settlementCtx) {
            let fullPaymentCount = 0;
            let partialPaymentCount = 0;

            transactionsData.forEach(transaction => {
                if (transaction.settlement_type === 'full') {
                    fullPaymentCount++;
                } else {
                    partialPaymentCount++;
                }
            });

            new Chart(settlementCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Full Payment', 'Partial Payments'],
                    datasets: [{
                        data: [fullPaymentCount, partialPaymentCount],
                        backgroundColor: ['#1cc88a', '#f6c23e'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = fullPaymentCount + partialPaymentCount;
                                    const percentage = Math.round((context.parsed / total) * 100);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
            const monthlyData = {};

            transactionsData.forEach(transaction => {
                const date = new Date(transaction.date);
                const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = 0;
                }
                monthlyData[monthKey] += transaction.total_amount;
            });

            const months = Object.keys(monthlyData);
            const amounts = Object.values(monthlyData);

            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Cleared Amount',
                        data: amounts,
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4e73df',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `AED ${context.parsed.y.toLocaleString('en-US', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return 'AED ' + value.toLocaleString('en-US', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }
    }
        setTimeout(() => {
            toastElement.remove();
        }, 3000);

</script>
{% endblock %}