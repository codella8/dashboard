{% extends "daily_sale/daily_sale_base.html" %}
{% load static humanize %}
{% block title %}Almuqbil | customer_detail{% endblock %}

{% block content %}
<div class="customer-detail-container">
    <div class="container">
        <!-- Customer Header -->
        <div class="glass-card fade-in">
            <div class="customer-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        {% if is_self_view %}
                        <h1 class="display-5 fw-bold mb-3">ðŸ‘‹ Hello, {{ customer.full_name }}</h1>
                        <p class="lead mb-0">
                            <i class="fas fa-envelope me-2"></i>{{ customer.email }} |
                            <i class="fas fa-phone ms-3 me-2"></i>{{ customer.phone|default:"Not provided" }}
                        </p>
                        {% else %}
                        <h1 class="display-5 fw-bold mb-3">
                            <i class="fas fa-user-tie me-3"></i>{{ customer.full_name }}
                        </h1>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2"><i class="fas fa-envelope me-2"></i>{{ customer.email }}</p>
                                <p class="mb-0"><i class="fas fa-phone me-2"></i>{{ customer.phone|default:"Not
                                    provided" }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><i class="fas fa-map-marker-alt me-2"></i>{{
                                    customer.address|default:"Address not provided"|truncatechars:50 }}</p>
                                <p class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Member since {{
                                    customer.created_at|date:"M d, Y" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex justify-content-end gap-3">
                            <button onclick="window.print()" class="btn print-btn no-print">
                                <i class="fas fa-print me-2"></i>Print Report
                            </button>
                            {% if not is_self_view %}
                            <a href="#" class="btn export-btn no-print">
                                <i class="fas fa-file-export me-2"></i>Export
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="p-4">
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="card stat-card sales h-100">
                            <div class="card-body">
                                <div class="stat-icon sales">
                                    <i class="fas fa-shopping-cart fa-2x"></i>
                                </div>
                                <h6 class="text-uppercase text-muted mb-2">Total Sales</h6>
                                <h2 class="mb-1">${{ total_sales|intcomma }}</h2>
                                <small class="text-muted">{{ transactions_count }} transactions</small>
                                {% if last_transaction %}
                                <div class="mt-3">
                                    <small><i class="fas fa-history me-1"></i>Last: {{ last_transaction|date:"M d, Y"
                                        }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card stat-card tax h-100">
                            <div class="card-body">
                                <div class="stat-icon tax">
                                    <i class="fas fa-receipt fa-2x"></i>
                                </div>
                                <h6 class="text-uppercase text-muted mb-2">Total Tax</h6>
                                <h2 class="mb-1">${{ total_tax|intcomma }}</h2>
                                <small class="text-muted">{{ tax_rate }}% tax rate</small>
                                <div class="mt-3">
                                    <small><i class="fas fa-percentage me-1"></i>Included in totals</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card stat-card paid h-100">
                            <div class="card-body">
                                <div class="stat-icon paid">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                                <h6 class="text-uppercase text-muted mb-2">Total Paid</h6>
                                <h2 class="mb-1 amount-positive">${{ total_paid|intcomma }}</h2>
                                <small class="text-muted">{{ total_paid|floatformat:0|intcomma }} paid</small>
                                <div class="progress mt-3" style="height: 6px;">
                                    {% if total_sales > 0 %}
                                    <div class="progress-bar bg-success"></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card stat-card debt h-100">
                            <div class="card-body">
                                <div class="stat-icon debt">
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                </div>
                                <h6 class="text-uppercase text-muted mb-2">Remaining Balance</h6>
                                <h2 class="mb-1 amount-negative">${{ total_remaining|intcomma }}</h2>
                                <small class="text-muted">Outstanding amount</small>
                                {% if total_remaining > 0 %}
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-credit-card me-1"></i>Request Payment
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter glass-card no-print">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control border-start-0"
                            placeholder="Search transactions by item, type, or note...">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-3 justify-content-end">
                        <select id="typeFilter" class="form-select" style="width: auto;">
                            <option value="">All Types</option>
                            <option value="sale">Sale</option>
                            <option value="return">Return</option>
                        </select>
                        <select id="dateFilter" class="form-select" style="width: auto;">
                            <option value="">All Time</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="glass-card fade-in">
            <div class="p-4">
                <h3 class="mb-4">
                    <i class="fas fa-history me-2"></i>
                    Transaction History
                    <span class="badge bg-primary ms-2">{{ transactions|length }} records</span>
                </h3>

                {% if transactions %}
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Item</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-end">Tax</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Paid</th>
                                    <th class="text-end">Balance</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr class="transaction-row" data-type="{{ tx.type|lower }}"
                                    data-date="{{ tx.date|date:'Y-m-d' }}">
                                    <td>
                                        <div class="fw-semibold">{{ tx.date|date:"M d, Y" }}</div>
                                        <small class="text-muted">{{ tx.date|date:"h:i A" }}</small>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {% if tx.type == 'sale' or tx.type == 'SALE' %}sale{% else %}return{% endif %}">
                                            {{ tx.type|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="fw-medium">{{ tx.item }}</div>
                                        <small class="text-muted">ID: {{ tx.id }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark">{{ tx.quantity }}</span>
                                    </td>
                                    <td class="text-end">${{ tx.unit_price|intcomma }}</td>
                                    <td class="text-end fw-semibold">${{ tx.total_amount|intcomma }}</td>
                                    <td class="text-end">
                                        <span class="text-muted">${{ tx.tax_amount|intcomma }}</span>
                                    </td>
                                    <td class="text-end fw-bold text-primary">${{ tx.total_with_tax|intcomma }}</td>
                                    <td class="text-end">
                                        <span class="amount-positive">${{ tx.paid_amount|intcomma }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span
                                            class="{% if tx.remaining_amount > 0 %}amount-negative{% else %}amount-positive{% endif %}">
                                            ${{ tx.remaining_amount|intcomma }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if tx.note %}
                                        <span class="d-inline-block text-truncate" style="max-width: 150px;"
                                            title="{{ tx.note }}">
                                            {{ tx.note }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-dark">
                                <tr>
                                    <th colspan="5" class="text-start">TOTALS</th>
                                    <th class="text-end">${{ total_sales|intcomma }}</th>
                                    <th class="text-end">${{ total_tax|intcomma }}</th>
                                    <th class="text-end">${{ total_sales|add:total_tax|intcomma }}</th>
                                    <th class="text-end amount-positive">${{ total_paid|intcomma }}</th>
                                    <th class="text-end amount-negative">${{ total_remaining|intcomma }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Summary -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Payment Status</h6>
                                {% if total_remaining == 0 %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                                    <div>
                                        <h4 class="mb-0">Fully Paid</h4>
                                        <small class="text-muted">All payments completed</small>
                                    </div>
                                </div>
                                {% elif total_remaining > 0 and total_remaining < total_sales %} <div
                                    class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                                    <div>
                                        <h4 class="mb-0">Partially Paid</h4>
                                        <small class="text-muted">
                                            {{ total_paid|floatformat:0|intcomma }}/{{
                                            total_sales|floatformat:0|intcomma }} paid
                                        </small>
                                    </div>
                            </div>
                            {% else %}
                            <div class="d-flex align-items-center">
                                <i class="fas fa-times-circle fa-2x text-danger me-3"></i>
                                <div>
                                    <h4 class="mb-0">Not Paid</h4>
                                    <small class="text-muted">No payments received</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Average Transaction</h6>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-bar fa-2x text-primary me-3"></i>
                                <div>
                                    {% if transactions_count > 0 %}
                                    <h4 class="mb-0">${{
                                        total_sales|floatformat:0|divisibleby:transactions_count|intcomma }}</h4>
                                    <small class="text-muted">Per transaction</small>
                                    {% else %}
                                    <h4 class="mb-0">$0</h4>
                                    <small class="text-muted">No transactions</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Tax Liability</h6>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-balance-scale fa-2x text-warning me-3"></i>
                                <div>
                                    <h4 class="mb-0">{{ tax_rate }}%</h4>
                                    <small class="text-muted">${{ total_tax|intcomma }} total tax</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-shopping-cart fa-3x text-muted"></i>
                </div>
                <h3 class="mb-3">No Transactions Found</h3>
                <p class="text-muted mb-4">
                    {% if is_self_view %}
                    You haven't made any purchases yet. Your transaction history will appear here once you start
                    shopping.
                    {% else %}
                    This customer hasn't made any purchases yet. Their transaction history will appear here once they
                    start shopping.
                    {% endif %}
                </p>
                {% if is_self_view %}
                <a href="{% url 'home' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-store me-2"></i>Start Shopping
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer Actions -->
    {% if not is_self_view %}
    <div class="glass-card no-print mt-4">
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">Customer Actions</h5>
                    <p class="text-muted mb-0">Manage this customer's account</p>
                </div>
                <div class="d-flex gap-3">
                    <a href="mailto:{{ customer.email }}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope me-2"></i>Send Email
                    </a>
                    <a href="tel:{{ customer.phone }}" class="btn btn-outline-success" {% if not customer.phone
                        %}disabled{% endif %}>
                        <i class="fas fa-phone me-2"></i>Call Customer
                    </a>
                    <button class="btn btn-outline-warning" onclick="sendPaymentReminder()">
                        <i class="fas fa-bell me-2"></i>Payment Reminder
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    document.getElementById('searchInput').addEventListener('keyup', function () {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#transactionsTable tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Filter by type
    document.getElementById('typeFilter').addEventListener('change', function () {
        const type = this.value;
        const rows = document.querySelectorAll('#transactionsTable tbody tr');

        rows.forEach(row => {
            if (!type) {
                row.style.display = '';
                return;
            }

            const rowType = row.getAttribute('data-type');
            row.style.display = rowType.includes(type) ? '' : 'none';
        });
    });

    // Filter by date
    document.getElementById('dateFilter').addEventListener('change', function () {
        const days = parseInt(this.value);
        if (!days) {
            // Show all rows
            document.querySelectorAll('#transactionsTable tbody tr').forEach(row => {
                row.style.display = '';
            });
            return;
        }

        const cutoffDate = new Date();
        cutoffDate.setDate(cutdownDate.getDate() - days);

        document.querySelectorAll('#transactionsTable tbody tr').forEach(row => {
            const rowDate = new Date(row.getAttribute('data-date'));
            row.style.display = rowDate >= cutoffDate ? '' : 'none';
        });
    });

    // Export functionality
    function exportToCSV() {
        const rows = document.querySelectorAll('#transactionsTable tr');
        let csv = [];

        // Add headers
        const headers = [];
        document.querySelectorAll('#transactionsTable thead th').forEach(th => {
            headers.push(th.textContent.trim());
        });
        csv.push(headers.join(','));

        // Add data rows
        rows.forEach(row => {
            if (row.querySelector('thead') || row.style.display === 'none') return;

            const rowData = [];
            row.querySelectorAll('td').forEach(td => {
                // Remove icons and extra formatting
                let text = td.textContent.trim();
                text = text.replace(/\$|,/g, '');
                rowData.push(`"${text}"`);
            });
            csv.push(rowData.join(','));
        });

        // Download CSV
        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `customer-{{ customer.id }}-transactions-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Print report with better formatting
    function printReport() {
        const originalTitle = document.title;
        document.title = `Customer Report - {{ customer.full_name }} - ${new Date().toLocaleDateString()}`;
        window.print();
        document.title = originalTitle;
    }

    // Payment reminder function
    function sendPaymentReminder() {
        if (confirm('Send payment reminder to {{ customer.full_name }}?')) {
            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
            btn.disabled = true;

            // Simulate API call
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Sent!';
                btn.classList.remove('btn-outline-warning');
                btn.classList.add('btn-success');

                // Show success message
                showNotification('Payment reminder sent successfully!', 'success');

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-warning');
                }, 3000);
            }, 1500);
        }
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Add hover effects to table rows
    document.querySelectorAll('#transactionsTable tbody tr').forEach(row => {
        row.addEventListener('mouseenter', function () {
            this.style.backgroundColor = '#f8fafc';
        });

        row.addEventListener('mouseleave', function () {
            this.style.backgroundColor = '';
        });
    });

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function () {
        const tooltips = document.querySelectorAll('[title]');
        tooltips.forEach(el => {
            new bootstrap.Tooltip(el);
        });
    });

    // Animate stats cards on scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate__animated', 'animate__fadeInUp');
            }
        });
    }, observerOptions);

    document.querySelectorAll('.stat-card').forEach(card => {
        observer.observe(card);
    });

    // Add export button functionality
    document.querySelector('.export-btn').addEventListener('click', function (e) {
        e.preventDefault();
        exportToCSV();
        showNotification('Export started. Your download will begin shortly.', 'info');
    });

    // Add print button functionality
    document.querySelector('.print-btn').addEventListener('click', printReport);
</script>

<!-- Animate.css for animations -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
{% endblock %}