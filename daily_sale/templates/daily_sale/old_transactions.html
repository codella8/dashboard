{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Outstanding Customers - Sales Management System{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-2 text-gray-800">
        <i class="bi bi-people text-danger me-2"></i>
        <strong>Outstanding Customers</strong>
      </h1>
      <p class="text-muted mb-0">
        <i class="bi bi-info-circle me-1"></i>
        Real-time tracking of customer debts and pending payments
      </p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-danger" id="refreshBtn">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
      </button>
      <button class="btn btn-outline-primary" onclick="exportToExcel()">
        <i class="bi bi-file-excel me-1"></i> Export
      </button>
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-filter me-1"></i> Filter
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="?filter=high">High Debt (> AED1,000)</a></li>
          <li><a class="dropdown-item" href="?filter=medium">Medium Debt (AED100-AED1,000)</a></li>
          <li><a class="dropdown-item" href="?filter=low">Low Debt (< AED100)</a>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item" href="?filter=recent">Recent (Last 7 days)</a></li>
          <li><a class="dropdown-item" href="?filter=old">Old (> 30 days)</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card outstanding-card border-left-danger h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-danger text-uppercase mb-2">Total Outstanding</h6>
              <h1 class="mb-2" style="font-size: small;">AED{{ total_outstanding|floatformat:0|intcomma }}</h1>
              <div class="d-flex align-items-center">
                <span class="badge bg-danger me-2">{{ customers_count }}</span>
                <small class="text-muted">Customers</small>
              </div>
            </div>
            <div class="text-danger opacity-25">
              <i class="bi bi-cash-stack display-6"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card outstanding-card border-left-warning h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-warning text-uppercase mb-2">Average Debt</h6>
              <h1 class="mb-2" style="font-size: small;">AED{{ avg_debt|floatformat:0|intcomma }}</h1>
              <div class="d-flex align-items-center">
                <span class="badge bg-warning me-2">{{ avg_transactions|floatformat:1 }}</span>
                <small class="text-muted">Avg Transactions</small>
              </div>
            </div>
            <div class="text-warning opacity-25">
              <i class="bi bi-graph-up display-6"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card outstanding-card border-left-info h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-info text-uppercase mb-2">Recent Additions</h6>
              <h1 class="mb-2">{{ recent_count }}</h1>
              <div class="d-flex align-items-center">
                <span class="badge bg-info me-2">{{ recent_amount|floatformat:0|intcomma }}</span>
                <small class="text-muted">Last 7 days</small>
              </div>
            </div>
            <div class="text-info opacity-25">
              <i class="bi bi-clock-history display-6"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card outstanding-card border-left-success h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-success text-uppercase mb-2">Oldest Debt</h6>
              <h3 class="mb-2" style="font-size: small;">{{ oldest_days }} days</h3>
              <div class="d-flex align-items-center">
                <span class="badge bg-success me-2 " style="font-size: small;">AED{{ oldest_amount|floatformat:0|intcomma }}</span>
                <small class="text-muted">Amount</small>
              </div>
            </div>
            <div class="text-success opacity-25">
              <i class="bi bi-calendar-x display-6"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Outstanding Customers Table -->
  <div class="card shadow mb-4">
    <div class="card-header bg-white border-0 py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-list-ul text-primary me-2"></i>
          Customer Debt Details
        </h5>
        <div class="d-flex align-items-center">
          <span class="text-muted me-3">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }}
          </span>
          <input type="text" class="form-control form-control-sm w-auto" placeholder="Search customer..."
            id="searchInput">
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="outstandingTable">
          <thead class="table-light">
            <tr>
              <th class="text-center">#</th>
              <th>Customer</th>
              <th class="text-center">Status</th>
              <th class="text-center">Transactions</th>
              <th>Last Transaction</th>
              <th class="text-end">Total Amount</th>
              <th class="text-end">Paid</th>
              <th class="text-end">Discount</th>
              <th class="text-end">Remaining</th>
              <th class="text-end">Due Days</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for customer in outstanding_data %}
            <tr
              class="align-middle {% if customer.debt_level == 'high' %}highlight-row{% elif customer.debt_level == 'medium' %}warning-row{% endif %}">
              <td class="text-center fw-bold">{{ forloop.counter0|add:page_obj.start_index }}</td>

              <!-- Customer Column -->
              <td>
                <div class="d-flex align-items-center">
                  <div class="customer-avatar me-3">
                    {{ customer.initials }}
                  </div>
                  <div class="customer-info">
                    <strong class="d-block">{{ customer.full_name }}</strong>
                    <small class="text-muted d-block">
                      <i class="bi bi-telephone me-1"></i>{{ customer.phone|default:"N/A" }}
                    </small>
                    <small class="text-muted">
                      <i class="bi bi-envelope me-1"></i>{{ customer.email|truncatechars:20|default:"N/A" }}
                    </small>
                  </div>
                </div>
              </td>

              <!-- Status Column -->
              <td class="text-center">
                <span
                  class="status-dot {% if customer.is_active %}status-active{% else %}status-inactive{% endif %}"></span>
                <span class="debt-badge {{ customer.debt_class }}">
                  {{ customer.debt_level|upper }}
                </span>
              </td>

              <!-- Transactions Column -->
              <td class="text-center">
                <div class="fw-bold">{{ customer.transactions_count }}</div>
                <div class="progress progress-thin mt-1">
                  <div class="progress-bar bg-info"></div>
                </div>
                <small class="text-muted">{{ customer.payment_percentage }}% paid</small>
              </td>

              <!-- Last Transaction Column -->
              <td>
                <div class="fw-medium">{{ customer.last_transaction.date|date:"M d, Y" }}</div>
                <div class="last-transaction">
                  <small class="d-block">
                    <i class="bi bi-receipt me-1"></i>
                    {{ customer.last_transaction.invoice|default:"N/A" }}
                  </small>
                  <small class="text-muted">
                    <i class="bi bi-box me-1"></i>
                    {{ customer.last_transaction.item|truncatechars:15|default:"N/A" }}
                  </small>
                </div>
              </td>

              <!-- Financial Columns -->
              <td class="text-end debt-amount text-dark">
                AED{{ customer.total_amount|floatformat:0|intcomma }}
              </td>

              <td class="text-end text-success">
                AED{{ customer.paid_amount|floatformat:0|intcomma }}
              </td>

              <td class="text-end text-warning">
                AED{{ customer.discount_amount|floatformat:0|intcomma }}
              </td>

              <td class="text-end text-danger fw-bold">
                AED{{ customer.remaining_amount|floatformat:0|intcomma }}
              </td>

              <!-- Due Days Column -->
              <td class="text-center">
                {% if customer.due_days > 30 %}
                <span class="badge bg-danger">{{ customer.due_days }} days</span>
                {% elif customer.due_days > 15 %}
                <span class="badge bg-warning">{{ customer.due_days }} days</span>
                {% else %}
                <span class="badge bg-success">{{ customer.due_days }} days</span>
                {% endif %}
              </td>

              <!-- Actions Column -->
              <td class="text-center">
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-primary action-btn"
                    onclick="viewCustomerDetails('{{ customer.id }}')" title="View Details">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-success action-btn" onclick="addPayment('{{ customer.id }}')"
                    title="Add Payment">
                    <i class="bi bi-cash-coin"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-warning action-btn dropdown-toggle" type="button"
                    data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="#" onclick="sendReminder('{{ customer.id }}')">
                        <i class="bi bi-bell me-2"></i>Send Reminder
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" onclick="viewTransactions('{{ customer.id }}')">
                        <i class="bi bi-receipt me-2"></i>View Transactions
                      </a>
                    </li>
                    <li>
                      <hr class="dropdown-divider">
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" href="#" onclick="confirmDelete('{{ customer.id }}')">
                        <i class="bi bi-trash me-2"></i>Delete Record
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>

            <!-- Transaction Details (Hidden Row) -->
            <tr class="transaction-details" id="details-{{ customer.id }}" style="display: none;">
              <td colspan="11" class="bg-light">
                <div class="p-3">
                  <h6 class="mb-3">
                    <i class="bi bi-receipt text-primary me-2"></i>
                    Outstanding Transactions for {{ customer.full_name }}
                  </h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead>
                        <tr class="table-secondary">
                          <th>Invoice #</th>
                          <th>Date</th>
                          <th>Item</th>
                          <th>Container</th>
                          <th class="text-end">Total</th>
                          <th class="text-end">Paid</th>
                          <th class="text-end">Discount</th>
                          <th class="text-end">Remaining</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for tx in customer.transactions %}
                        <tr>
                          <td>
                            <a href="{% url 'daily_sale:transaction_detail' tx.id %}" class="text-primary">
                              {{ tx.invoice_number }}
                            </a>
                          </td>
                          <td>{{ tx.date|date:"Y-m-d" }}</td>
                          <td>
                            {% if tx.item %}
                            {{ tx.item.product_name|truncatechars:20 }}
                            {% else %}
                            N/A
                            {% endif %}
                          </td>
                          <td>
                            {% if tx.container %}
                            {{ tx.container.name|truncatechars:15 }}
                            {% else %}
                            N/A
                            {% endif %}
                          </td>
                          <td class="text-end" style="font-size: small;">AED{{ tx.total_amount|floatformat:2 }}</td>
                          <td class="text-end text-success" style="font-size: small;">AED{{ tx.paid_amount|floatformat:2 }}</td>
                          <td class="text-end text-warning" style="font-size: small;">AED{{ tx.discount|floatformat:2 }}</td>
                          <td class="text-end text-danger fw-bold" style="font-size: small;">AED{{ tx.remaining|floatformat:2 }}</td>
                          <td>
                            {% if tx.remaining == 0 %}
                            <span class="badge bg-success">Paid</span>
                            {% elif tx.paid_amount > 0 %}
                            <span class="badge bg-warning">Partial</span>
                            {% else %}
                            <span class="badge bg-danger">Unpaid</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="11" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-emoji-smile display-6 d-block mb-3"></i>
                  <h5>No Outstanding Customers</h5>
                  <p class="mb-0">All customers have cleared their payments!</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th colspan="5" class="text-end">TOTALS:</th>
              <th class="text-end" style="font-size: small;">AED{{ total_amount|floatformat:0|intcomma }}</th>
              <th class="text-end" style="font-size: small;">AED{{ total_paid|floatformat:0|intcomma }}</th>
              <th class="text-end" style="font-size: small;">AED{{ total_discount|floatformat:0|intcomma }}</th>
              <th class="text-end text-danger" style="font-size: small;">AED{{ total_remaining|floatformat:0|intcomma }}</th>
              <th colspan="2"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="card-footer bg-white">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1">
              <i class="bi bi-chevron-double-left"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                <i class="bi bi-chevron-right"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                <i class="bi bi-chevron-double-right"></i>
              </a>
            </li>
            {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Payment form will be loaded via AJAX -->
        <div id="paymentFormContainer"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Auto-refresh every 60 seconds
  let refreshTimer = setInterval(() => {
    refreshData();
  }, 60000);

  function refreshData() {
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      const originalHtml = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
      refreshBtn.disabled = true;

      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', refreshData);

  // Search functionality
  document.getElementById('searchInput')?.addEventListener('keyup', function (e) {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#outstandingTable tbody tr:not(.transaction-details)');

    rows.forEach(row => {
      const customerName = row.querySelector('.customer-info strong').textContent.toLowerCase();
      const customerPhone = row.querySelector('.customer-info small:nth-child(2)').textContent.toLowerCase();
      const customerEmail = row.querySelector('.customer-info small:nth-child(3)').textContent.toLowerCase();

      if (customerName.includes(searchTerm) ||
        customerPhone.includes(searchTerm) ||
        customerEmail.includes(searchTerm)) {
        row.style.display = '';
        // Hide transaction details if visible
        const customerId = row.querySelector('.action-btn').getAttribute('onclick').match(/'([^']+)'/)[1];
        const detailsRow = document.getElementById(`details-AED{customerId}`);
        if (detailsRow) detailsRow.style.display = 'none';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // View customer details
  function viewCustomerDetails(customerId) {
    const detailsRow = document.getElementById(`details-AED{customerId}`);
    if (detailsRow) {
      detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
    }
  }

  // Add payment
  function addPayment(customerId) {
    fetch(`/daily_sale/customers/AED{customerId}/payment-form/`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('paymentFormContainer').innerHTML = html;
        new bootstrap.Modal(document.getElementById('paymentModal')).show();
      });
  }

  // Send reminder
  function sendReminder(customerId) {
    if (confirm('Send payment reminder to this customer?')) {
      fetch(`/daily_sale/customers/AED{customerId}/send-reminder/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Reminder sent successfully!');
          }
        });
    }
  }

  // View transactions
  function viewTransactions(customerId) {
    window.location.href = `{% url 'daily_sale:transaction_list' %}?customer=AED{customerId}`;
  }

  // Confirm delete
  function confirmDelete(customerId) {
    if (confirm('Are you sure you want to delete this customer record? This action cannot be undone.')) {
      fetch(`/daily_sale/customers/AED{customerId}/delete/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          }
        });
    }
  }

  // Export to Excel
  function exportToExcel() {
    const url = new URL(window.location.href);
    url.searchParams.set('export', 'excel');
    window.open(url.toString(), '_blank');
  }

  // Sort by debt level
  function sortByDebt(level) {
    const rows = Array.from(document.querySelectorAll('#outstandingTable tbody tr:not(.transaction-details)'));

    rows.sort((a, b) => {
      const debtA = a.querySelector('.debt-badge').textContent.trim();
      const debtB = b.querySelector('.debt-badge').textContent.trim();

      if (level === 'high') {
        return debtA === 'HIGH' ? -1 : 1;
      } else if (level === 'low') {
        return debtA === 'LOW' ? -1 : 1;
      }
      return 0;
    });

    const tbody = document.querySelector('#outstandingTable tbody');
    rows.forEach(row => tbody.appendChild(row));
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function (e) {
    // Ctrl+F to search
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      document.getElementById('searchInput')?.focus();
    }
    // F5 to refresh
    if (e.key === 'F5') {
      e.preventDefault();
      refreshData();
    }
    // Ctrl+E to export
    if (e.ctrlKey && e.key === 'e') {
      e.preventDefault();
      exportToExcel();
    }
  });
</script>
{% endblock %}