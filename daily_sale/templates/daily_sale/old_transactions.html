{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Almuqbil | Old Transactions{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-2 text-gray-800">
        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
        Old Transactions
      </h1>
      <p class="text-muted mb-0">
        <i class="fas fa-info-circle me-1"></i>
        Customers with pending payments
      </p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" onclick="exportToExcel()">
        <i class="fas fa-file-excel me-1"></i> Export
      </button>
      <button class="btn btn-danger" id="refreshBtn">
        <i class="fas fa-sync-alt me-1"></i> Refresh
      </button>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-danger text-uppercase mb-2">Total Old transactions</h6>
              <h2 class="mb-2">AED {{ total_outstanding|floatformat:0|intcomma }}</h2>
              <div class="d-flex align-items-center">
                <span class="badge bg-danger me-2">{{ customers_count }}</span>
                <small class="text-muted">Customers</small>
              </div>
            </div>
            <div class="text-danger opacity-25">
              <i class="fas fa-money-bill-wave fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-warning text-uppercase mb-2">Average Debt</h6>
              <h2 class="mb-2">AED {{ avg_debt|floatformat:0|intcomma }}</h2>
              <div class="d-flex align-items-center">
                <span class="badge bg-warning me-2">{{ customers_count }}</span>
                <small class="text-muted">Active Debts</small>
              </div>
            </div>
            <div class="text-warning opacity-25">
              <i class="fas fa-chart-line fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-info text-uppercase mb-2">Total Amount</h6>
              <h2 class="mb-2">AED {{ total_amount|floatformat:0|intcomma }}</h2>
              <div class="d-flex align-items-center">
                <span class="badge bg-info me-2">{{ customers_count }}</span>
                <small class="text-muted">All Transactions</small>
              </div>
            </div>
            <div class="text-info opacity-25">
              <i class="fas fa-calculator fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-success text-uppercase mb-2">Paid Amount</h6>
              <h2 class="mb-2">AED {{ total_paid|floatformat:0|intcomma }}</h2>
              <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">{{ customers_count }}</span>
                <small class="text-muted">Collected</small>
              </div>
            </div>
            <div class="text-success opacity-25">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <form method="get" class="d-flex">
            <input type="text" class="form-control me-2" name="search" placeholder="Search customer..."
              value="{{ search_query }}">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i>
            </button>
          </form>
        </div>
        <div class="col-md-4">
          <select class="form-select" id="statusFilter" onchange="filterByStatus(this.value)">
            <option value="">All Status</option>
            <option value="partial" {% if filter_type=='partial' %}selected{% endif %}>Partial Paid</option>
            <option value="paid" {% if filter_type=='paid' %}selected{% endif %}>Fully Paid</option>
          </select>
        </div>
        <div class="col-md-4">
          <select class="form-select" id="sortSelect" onchange="sortByDebt(this.value)">
            <option value="debt_desc" {% if sort_by=='debt_desc' %}selected{% endif %}>Highest Debt First</option>
            <option value="debt_asc" {% if sort_by=='debt_asc' %}selected{% endif %}>Lowest Debt First</option>
          </select>
        </div>
      </div>
    </div>
  </div>


  <div class="card shadow">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-users me-2"></i>
        Old Transactions List
      </h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Customer Name</th>
              <th class="text-end">Total Amount</th>
              <th class="text-end">Paid Amount</th>
              <th class="text-end">Discount</th>
              <th class="text-end">Remaining</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for customer in outstanding_customers %}
            <tr
              class="{% if customer.remaining_amount > 10000 %}table-danger{% elif customer.remaining_amount > 5000 %}table-warning{% endif %}">
              <td>{{ forloop.counter }}</td>
              <td>
                <strong>{{ customer.customer_name }}</strong><br>
                <small class="text-muted">ID: {{ customer.customer_id }}</small>
              </td>
              <td class="text-end">
                AED {{ customer.total_amount|floatformat:2|intcomma }}
              </td>
              <td class="text-end text-success">
                AED {{ customer.paid_amount|floatformat:2|intcomma }}
              </td>
              <td class="text-end text-warning">
                AED {{ customer.discount_amount|floatformat:2|intcomma }}
              </td>
              <td class="text-end text-danger fw-bold">
                AED {{ customer.remaining_amount|floatformat:2|intcomma }}
              </td>
              <td>
                {% if customer.payment_status == 'paid' %}
                <span class="badge bg-success">Paid</span>
                {% elif customer.payment_status == 'partial' %}
                <span class="badge bg-warning">Partial</span>
                {% else %}
                <span class="badge bg-danger">Unpaid</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary view-customer-btn"
                    data-customer-id="{{ customer.customer_id }}">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-success add-payment-btn"
                    data-customer-id="{{ customer.customer_id }}">
                    <i class="fas fa-money-bill"></i>
                  </button>
                  <a href="{% url 'daily_sale:transaction_list' %}?customer={{ customer.customer_id }}"
                    class="btn btn-sm btn-outline-info">
                    <i class="fas fa-receipt"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4">
                <div class="text-muted">
                  <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                  <h5>No Old Transactions</h5>
                  <p>All customers have cleared their payments!</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th colspan="2" class="text-end">TOTALS:</th>
              <th class="text-end">AED {{ total_amount|floatformat:0|intcomma }}</th>
              <th class="text-end text-success">AED {{ total_paid|floatformat:0|intcomma }}</th>
              <th class="text-end text-warning">AED {{ total_discount|floatformat:0|intcomma }}</th>
              <th class="text-end text-danger fw-bold">AED {{ total_remaining|floatformat:0|intcomma }}</th>
              <th colspan="2"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  {% if outstanding_customers %}
  <div id="chart-data" data-customers='{{ customers_json|safe }}' style="display: none;"></div>
  <div class="row mt-4">
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Debt Distribution</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 300px;">
            <canvas id="debtChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-percentage me-2"></i>Payment Status</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 300px;">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Customer Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="customerDetails">
        <!-- Details will be loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="paymentForm">
        <!-- Payment form will be loaded via AJAX -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {

    let refreshInterval = setInterval(refreshData, 120000);
    let autoRefreshEnabled = false;
    initializeCharts();

    document.getElementById('refreshBtn').addEventListener('click', function () {
      window.location.reload();
    });      
  });

  function refreshData() {
    if (!autoRefreshEnabled) return;

    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      const originalHTML = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
      refreshBtn.disabled = true;

      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }
  }

  function filterByStatus(status) {
    const url = new URL(window.location.href);
    if (status) {
      url.searchParams.set('filter', status);
    } else {
      url.searchParams.delete('filter');
    }
    window.location.href = url.toString();
  }

  function sortByDebt(sortBy) {
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sortBy);
    window.location.href = url.toString();
  }

  function initializeCharts() {
    const chartDataElement = document.getElementById('chart-data');
    if (!chartDataElement) return;

    try {
      const customers = JSON.parse(chartDataElement.dataset.customers);

      const debtCtx = document.getElementById('debtChart');
      if (debtCtx && customers.length > 0) {
        const debtRanges = {
          '0-1,000': 0,
          '1,001-5,000': 0,
          '5,001-10,000': 0,
          '10,001-20,000': 0,
          '20,000+': 0
        };

        customers.forEach(customer => {
          const amount = customer.remaining_amount || 0;
          if (amount <= 1000) debtRanges['0-1,000']++;
          else if (amount <= 5000) debtRanges['1,001-5,000']++;
          else if (amount <= 10000) debtRanges['5,001-10,000']++;
          else if (amount <= 20000) debtRanges['10,001-20,000']++;
          else debtRanges['20,000+']++;
        });

        new Chart(debtCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(debtRanges),
            datasets: [{
              label: 'Number of Customers',
              data: Object.values(debtRanges),
              backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      const statusCtx = document.getElementById('statusChart');
      if (statusCtx && customers.length > 0) {
        let paidCount = 0;
        let partialCount = 0;
        let unpaidCount = 0;

        customers.forEach(customer => {
          if (customer.payment_status === 'paid') paidCount++;
          else if (customer.payment_status === 'partial') partialCount++;
          else unpaidCount++;
        });

        new Chart(statusCtx, {
          type: 'doughnut',
          data: {
            labels: ['Paid', 'Partial', 'Unpaid'],
            datasets: [{
              data: [paidCount, partialCount, unpaidCount],
              backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            },
            cutout: '70%'
          }
        });
      }
    } catch (error) {
      console.error('Error initializing charts:', error);
    }
  }

  function viewCustomerDetails(customerId) {
    fetch(`/api/customers/${customerId}/details/`)
      .then(response => response.json())
      .then(data => {
        const modalBody = document.getElementById('customerDetails');
        modalBody.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Customer Information</h6>
              <p><strong>Name:</strong> ${data.name}</p>
              <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
              <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
            </div>
            <div class="col-md-6">
              <h6>Financial Summary</h6>
              <p><strong>Total Transactions:</strong> ${data.total_transactions}</p>
              <p><strong>Total Amount:</strong> AED ${data.total_amount}</p>
              <p><strong>Total Paid:</strong> AED ${data.total_paid}</p>
              <p><strong>Remaining:</strong> <span class="text-danger">AED ${data.remaining}</span></p>
            </div>
          </div>
          <hr>
          <h6>Recent Transactions</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Invoice</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${data.recent_transactions.map(tx => `
                  <tr>
                    <td>${tx.date}</td>
                    <td>${tx.invoice}</td>
                    <td>AED ${tx.amount}</td>
                    <td><span class="badge ${tx.status === 'paid' ? 'bg-success' : tx.status === 'partial' ? 'bg-warning' : 'bg-danger'}">${tx.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        new bootstrap.Modal(document.getElementById('customerModal')).show();
      })
      .catch(error => {
        console.error('Error loading customer details:', error);
        alert('Error loading customer details');
      });
  }

  function addPayment(customerId) {
    fetch(`/api/customers/${customerId}/payment-form/`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('paymentForm').innerHTML = html;
        new bootstrap.Modal(document.getElementById('paymentModal')).show();

        document.getElementById('paymentForm').addEventListener('submit', function (e) {
          e.preventDefault();
          processPayment(customerId);
        });
      })
      .catch(error => {
        console.error('Error loading payment form:', error);
        alert('Error loading payment form');
      });
  }

  function processPayment(customerId) {
    const formData = new FormData(document.getElementById('paymentForm'));

    fetch(`/api/customers/${customerId}/add-payment/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Payment added successfully!');
          bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
          window.location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error processing payment:', error);
        alert('Error processing payment');
      });
  }

  function exportToPDF() {
    const url = new URL(window.location.href);
    url.searchParams.set('export', 'pdf');
    window.open(url.toString(), '_blank');
  }

  function sendReminders() {
    if (confirm('Send payment reminders to all customers with outstanding balances?')) {
      fetch('/api/send-reminders/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Reminders sent to ${data.count} customers`);
          } else {
            alert('Error sending reminders');
          }
        })
        .catch(error => {
          console.error('Error sending reminders:', error);
          alert('Error sending reminders');
        });
    }
  }

  function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    setTimeout(() => toast.remove(), 3000);
  }
</script>
{% endblock %}