{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}OldTransactions | Almuqbil {% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="card shadow mb-4">
    <div class="card-header bg-danger text-white">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Old Transactions
          </h4>
        </div>
        <div class="text-end">
          <h3 class="mb-0">{{ customers_count }} Customers</h3>
          <small>With Old Tranactions balance</small>
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" name="search" class="form-control" placeholder="Search customer (name, phone, email)..."
              value="{{ search_query }}">
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Error:</strong> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-start-danger border-start-3 shadow-sm hover-lift">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1">Total Debt</h6>
              <h4 class="mb-0 text-danger">
                AED {{ total_summary.total_debt|floatformat:0|intcomma }}
              </h4>
            </div>
            <div class="ms-3">
              <i class="fas fa-money-bill-wave fa-2x text-danger"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Total Paid
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                AED {{ total_summary.total_paid|floatformat:0|intcomma }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-start-warning border-start-3 shadow-sm hover-lift">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1">Old Transactions</h6>
              <h4 class="mb-0 text-warning">
                {{ total_summary.total_transactions }}
              </h4>
            </div>
            <div class="ms-3">
              <i class="fas fa-receipt fa-2x text-warning"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-start-info border-start-3 shadow-sm hover-lift">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1">Customers</h6>
              <h4 class="mb-0 text-info">
                {{ total_summary.total_customers }}
              </h4>
            </div>
            <div class="ms-3">
              <i class="fas fa-users fa-2x text-info"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customers List -->
  <div class="card shadow">
    <div class="card-header bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-users me-2"></i>
          Outstanding Customers List ({{ customers_count }})
        </h5>
        <div class="btn-group">
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="exportToExcel()">
            <i class="fas fa-file-excel me-1"></i> Export
          </button>
          <a href="?" class="btn btn-outline-secondary btn-sm ms-2">
            <i class="fas fa-sync-alt me-1"></i> Refresh
          </a>
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      {% if outstanding_customers %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th width="50">#</th>
              <th>Customer</th>
              <th width="150">Contact</th>
              <th width="150" class="text-end">Total Amount</th>
              <th width="150" class="text-end">Paid</th>
              <th width="150" class="text-end">Balance</th>
              <th width="120" class="text-center">Transactions</th>
              <th width="180" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for customer in outstanding_customers %}
            <tr id="customer-row-{{ customer.customer_id }}" class="customer-row 
              {% if customer.balance_type == 'debt' %}table-danger-light
              {% elif customer.balance_type == 'overpayment' %}table-success-light
              {% endif %}">
              <td class="text-muted">{{ forloop.counter }}</td>

              <!-- Customer Info -->
              <td>
                <div class="d-flex flex-column">
                  <strong class="customer-name mb-1">{{ customer.customer_name }}</strong>
                  {% if customer.customer_email %}
                  <small class="text-muted text-truncate" style="max-width: 200px;">
                    <i class="fas fa-envelope me-1"></i>{{ customer.customer_email }}
                  </small>
                  {% endif %}
                </div>
              </td>

              <!-- Contact -->
              <td>
                {% if customer.customer_phone %}
                <div class="d-flex align-items-center">
                  <i class="fas fa-phone me-2 text-primary"></i>
                  <span>{{ customer.customer_phone }}</span>
                </div>
                {% else %}
                <span class="text-muted">
                  <i class="fas fa-phone-slash me-1"></i> No Phone
                </span>
                {% endif %}
              </td>

              <!-- Total Amount -->
              <td class="text-end">
                <span class="fw-bold">
                  AED {{ customer.total_debt|floatformat:0|intcomma }}
                </span>
              </td>

              <!-- Paid -->
              <td class="text-end text-success">
                <span class="fw-bold">
                  AED {{ customer.total_paid|floatformat:0|intcomma }}
                </span>
              </td>

              <!-- Balance -->
              <td class="text-end">
                {% if customer.balance_type == 'debt' %}
                <span class="text-danger fw-bold balance-amount">
                  AED {{ customer.remaining_balance|floatformat:0|intcomma }}
                </span>
                {% elif customer.balance_type == 'overpayment' %}
                <span class="text-success fw-bold balance-amount">
                  AED {{ customer.remaining_balance|floatformat:0|intcomma }}
                </span>
                {% else %}
                <span class="text-secondary fw-bold balance-amount">
                  AED {{ customer.remaining_balance|floatformat:0|intcomma }}
                </span>
                {% endif %}
              </td>

              <!-- Transactions -->
              <td class="text-center">
                <span class="badge bg-info rounded-pill px-3 py-2 transaction-count">
                  <i class="fas fa-receipt me-1"></i>
                  {{ customer.debt_transactions_count }}
                </span>
              </td>

              <!-- Actions -->
              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-primary"
                    onclick="toggleCustomerDetails('{{ customer.customer_id }}')" title="View Details"
                    id="details-btn-{{ customer.customer_id }}">
                    <i class="fas fa-eye"></i>
                  </button>

                  <a href="{% url 'daily_sale:transaction_list' %}?customer={{ customer.customer_id }}"
                    class="btn btn-outline-info" title="View Transactions">
                    <i class="fas fa-receipt"></i>
                  </a>

                  {% if customer.customer_phone %}
                  <a href="tel:{{ customer.customer_phone }}" class="btn btn-outline-success" title="Call">
                    <i class="fas fa-phone"></i>
                  </a>
                  {% endif %}
                </div>
              </td>
            </tr>

            <!-- Details Row (Hidden) -->
            {% if customer.transactions %}
            <tr class="customer-details-row" id="details-{{ customer.customer_id }}" style="display: none;">
              <td colspan="8" class="bg-light">
                <div class="p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                      <i class="fas fa-file-invoice-dollar me-2"></i>
                      {{ customer.customer_name }} Transaction Details
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                      onclick="toggleCustomerDetails('{{ customer.customer_id }}')">
                      <i class="fas fa-times"></i> Close
                    </button>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead>
                        <tr class="table-secondary">
                          <th>Invoice No.</th>
                          <th>Date</th>
                          <th class="text-end">Total Amount</th>
                          <th class="text-end">Paid</th>
                          <th class="text-end">Balance</th>
                          <th class="text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for transaction in customer.transactions %}
                        <tr>
                          <td>
                            <strong>{{ transaction.invoice_number }}</strong>
                          </td>
                          <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                          <td class="text-end">
                            AED {{ transaction.total_amount|floatformat:0|intcomma }}
                          </td>
                          <td class="text-end text-success">
                            AED {{ transaction.total_paid|floatformat:0|intcomma }}
                          </td>
                          <td class="text-end text-danger fw-bold">
                            AED {{ transaction.remaining_debt|floatformat:0|intcomma }}
                          </td>
                          <td class="text-center">
                            {% if transaction.payment_status_display == 'Paid' %}
                            <span class="badge bg-success">Paid</span>
                            {% elif transaction.payment_status_display == 'Partial' %}
                            <span class="badge bg-warning">Partial</span>
                            {% else %}
                            <span class="badge bg-danger">Unpaid</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                      <tfoot>
                        <tr class="table-light">
                          <td colspan="2" class="text-end"><strong>Total:</strong></td>
                          <td class="text-end">
                            <strong>AED {{ customer.total_debt|floatformat:0|intcomma }}</strong>
                          </td>
                          <td class="text-end text-success">
                            <strong>AED {{ customer.total_paid|floatformat:0|intcomma }}</strong>
                          </td>
                          <td class="text-end text-danger">
                            <strong>AED {{ customer.remaining_balance|floatformat:0|intcomma }}</strong>
                          </td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th colspan="3" class="text-end">Total:</th>
              <th class="text-end">
                <strong>AED {{ total_summary.total_debt|floatformat:0|intcomma }}</strong>
              </th>
              <th class="text-end text-success">
                <strong>AED {{ total_summary.total_paid|floatformat:0|intcomma }}</strong>
              </th>
              <th class="text-end text-danger">
                <strong>AED {{ total_summary.total_debt|floatformat:0|intcomma}}</strong>
              </th>
              <th class="text-center">
                <strong>{{ total_summary.total_transactions }}</strong>
              </th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
        <h4 class="text-success">No Outstanding Customers Found</h4>
        <p class="text-muted mb-4">All customers have cleared their accounts.</p>
        <div class="d-flex justify-content-center gap-2">
          <a href="{% url 'daily_sale:transaction_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-receipt me-1"></i> View All Transactions
          </a>
        </div>
      </div>
      {% endif %}
    </div>

    {% if outstanding_customers %}
    <div class="card-footer">
      <div class="row align-items-center">
        <div class="col-md-6">
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Showing {{ customers_count }} customers
          </small>
        </div>
        <div class="col-md-6 text-end">
          <small class="text-muted">
            Date: {% now "Y/m/d" %}
          </small>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Outstanding Customers - Main JavaScript
  let currentOpenDetails = null;

  // Toggle customer details
  function toggleCustomerDetails(customerId) {
    const detailsRow = document.getElementById(`details-${customerId}`);
    const detailsBtn = document.getElementById(`details-btn-${customerId}`);

    if (!detailsRow) return;

    // Close previous details
    if (currentOpenDetails && currentOpenDetails !== detailsRow) {
      currentOpenDetails.style.display = 'none';
      const prevBtn = document.getElementById(`details-btn-${currentOpenDetails.id.split('-')[1]}`);
      if (prevBtn) {
        prevBtn.innerHTML = '<i class="fas fa-eye"></i>';
        prevBtn.classList.remove('btn-primary');
        prevBtn.classList.add('btn-outline-primary');
      }
    }

    // Toggle current
    if (detailsRow.style.display === 'none') {
      detailsRow.style.display = 'table-row';
      if (detailsBtn) {
        detailsBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        detailsBtn.classList.remove('btn-outline-primary');
        detailsBtn.classList.add('btn-primary');
      }
      currentOpenDetails = detailsRow;
    } else {
      detailsRow.style.display = 'none';
      if (detailsBtn) {
        detailsBtn.innerHTML = '<i class="fas fa-eye"></i>';
        detailsBtn.classList.remove('btn-primary');
        detailsBtn.classList.add('btn-outline-primary');
      }
      currentOpenDetails = null;
    }
  }

  // Export to Excel
  function exportToExcel() {
    try {
      let csv = 'Customer Name,Email,Phone,Total Amount,Paid,Balance,Transactions\n';

      // Collect data
      document.querySelectorAll('tbody tr.customer-row').forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
          const customerName = cells[1].querySelector('.customer-name')?.textContent?.trim() || '';
          const email = cells[1].querySelector('small.text-muted')?.textContent?.trim().replace('âœ‰', '') || '';
          const phone = cells[2].textContent.replace(/[^\d]/g, '').trim();
          const totalAmount = cells[3].textContent.replace('AED', '').replace(/,/g, '').trim();
          const paid = cells[4].textContent.replace('AED', '').replace(/,/g, '').trim();
          const balance = cells[5].textContent.replace('AED', '').replace(/,/g, '').trim();
          const transactions = cells[6].textContent.replace(/[^\d]/g, '').trim();

          csv += `"${customerName}","${email}","${phone}","${totalAmount}","${paid}","${balance}","${transactions}"\n`;
        }
      });

      // Create and download file
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const date = new Date().toISOString().split('T')[0];
      a.download = `outstanding_customers_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      showNotification('File downloaded successfully', 'success');
    } catch (error) {
      console.error('Export error:', error);
      showNotification('Error creating file', 'error');
    }
  }

  // Show notification
  function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'danger' : type;

    // Remove existing notifications
    document.querySelectorAll('.custom-notification').forEach(n => n.remove());

    // Create notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${alertClass} alert-dismissible fade show custom-notification`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    `;

    notification.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }
    }, 3000);
  }
</script>

{% endblock %}