{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}daily_summary | Almuqbil{% endblock %}

{% block content %}
<div class="financial-report-container">
  <!-- Report Header -->
  <div class="report-header">
    <div class="report-header-pattern"></div>
    <div class="report-title-section">
      <h1 class="report-title">daily_summary</h1>
      <p class="report-subtitle">Almuqbil Motors - Professional Financial Analysis</p>
      <div class="report-period">
        <i class="fas fa-calendar-alt me-2"></i>
        {{ report_title }}
      </div>
    </div>
  </div>

  <!-- Report Controls -->
  <div class="report-controls">
    <div class="report-type-selector">
      <a href="?type=daily&date={{ target_date|date:'Y-m-d' }}"
        class="report-type-btn {% if report_type == 'daily' %}active{% endif %}">
        <i class="fas fa-calendar-day me-2"></i>Daily Report
      </a>
      <a href="?type=weekly&date={{ target_date|date:'Y-m-d' }}"
        class="report-type-btn {% if report_type == 'weekly' %}active{% endif %}">
        <i class="fas fa-calendar-week me-2"></i>Weekly Report
      </a>
      <a href="?type=monthly&date={{ target_date|date:'Y-m-d' }}"
        class="report-type-btn {% if report_type == 'monthly' %}active{% endif %}">
        <i class="fas fa-calendar-alt me-2"></i>Monthly Report
      </a>
      <a href="?type=yearly&date={{ target_date|date:'Y-m-d' }}"
        class="report-type-btn {% if report_type == 'yearly' %}active{% endif %}">
        <i class="fas fa-calendar-year me-2"></i>Yearly Report
      </a>
    </div>

    <div class="date-navigation">
      <button class="date-btn" onclick="navigateDate('prev')">
        <i class="fas fa-chevron-left"></i>
      </button>

      <div class="current-date">
        {% if report_type == 'daily' %}
        {{ target_date|date:"F d, Y" }}
        {% elif report_type == 'weekly' %}
        Week of {{ week_start|date:"M d" }} - {{ week_end|date:"M d, Y" }}
        {% elif report_type == 'monthly' %}
        {{ target_date|date:"F Y" }}
        {% else %}
        {{ target_date.year }}
        {% endif %}
      </div>

      <button class="date-btn" onclick="navigateDate('next')">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-danger mx-4 mt-4" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Error!</strong> {{ error_message }}
  </div>
  {% endif %}

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-grid">
      <!-- Total Sales -->
      <div class="summary-card sales-card">
        <div class="summary-card-header">
          <div class="summary-title">Total Sales</div>
          <div class="summary-icon">
            <i class="fas fa-cash-register"></i>
          </div>
        </div>
        <div class="summary-value">
          {{ period_stats.total_sales|default:0|floatformat:0|intcomma }}
          <span class="summary-currency">AED</span>
        </div>
        <div class="summary-details">
          <i class="fas fa-shopping-cart"></i>
          {{ period_stats.total_transactions|default:0 }} transactions
          {% if previous_period_stats.total_sales %}
          <span
            class="summary-change {% if period_stats.total_sales > previous_period_stats.total_sales %}change-positive{% else %}change-negative{% endif %}">
            {% with change=period_stats.total_sales|default:0 %}
            {% if change > 0 %}+{% endif %}{{ change|floatformat:0|intcomma }} AED
            {% endwith %}
          </span>
          {% endif %}
        </div>
      </div>

      <!-- Net Profit -->
      <div class="summary-card profit-card">
        <div class="summary-card-header">
          <div class="summary-title">Net Profit</div>
          <div class="summary-icon">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div
          class="summary-value {% if period_stats.total_profit|default:0 >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ period_stats.total_profit|default:0|floatformat:0|intcomma }}
          <span class="summary-currency">AED</span>
        </div>
        <div class="summary-details">
          <i class="fas fa-percent"></i>
          {% if period_stats.total_sales and period_stats.total_sales > 0 %}
          {{ period_stats.total_profit|default:0|floatformat:1 }}% margin
          {% else %}
          0% margin
          {% endif %}
        </div>
      </div>

      <!-- Cash In -->
      <div class="summary-card cash-in-card">
        <div class="summary-card-header">
          <div class="summary-title">Cash In</div>
          <div class="summary-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
        </div>
        <div class="summary-value">
          {{ cash_flow.cash_in|default:0|floatformat:0|intcomma }}
          <span class="summary-currency">AED</span>
        </div>
        <div class="summary-details">
          <i class="fas fa-arrow-down"></i>
          Collected payments
          <span class="summary-change change-positive">
            {{ collection_rate|default:0|floatformat:1 }}% collection rate
          </span>
        </div>
      </div>

      <!-- Cash Out -->
      <div class="summary-card cash-out-card">
        <div class="summary-card-header">
          <div class="summary-title">Cash Out</div>
          <div class="summary-icon">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
        </div>
        <div class="summary-value">
          {{ cash_flow.cash_out|default:0|floatformat:0|intcomma }}
          <span class="summary-currency">AED</span>
        </div>
        <div class="summary-details">
          <i class="fas fa-arrow-up"></i>
          Purchase expenses
        </div>
      </div>

      <!-- Transactions -->
      <div class="summary-card transactions-card">
        <div class="summary-card-header">
          <div class="summary-title">Transactions</div>
          <div class="summary-icon">
            <i class="fas fa-exchange-alt"></i>
          </div>
        </div>
        <div class="summary-value">
          {{ period_stats.total_transactions|default:0|intcomma }}
        </div>
        <div class="summary-details">
          <i class="fas fa-box"></i>
          {{ period_stats.total_items_sold|default:0|intcomma }} items sold
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Breakdown -->
  <div class="daily-breakdown">
    <div class="section-title">
      <i class="fas fa-calendar-alt"></i>Daily Financial Breakdown
    </div>

    <div class="financial-table">
      <div class="table-header">
        <div>Date</div>
        <div class="text-right">Sales</div>
        <div class="text-right">Profit</div>
        <div class="text-right">Cash In</div>
        <div class="text-right">Cash Out</div>
        <div class="text-right">Transactions</div>
        <div class="text-right">Items</div>
      </div>

      {% if daily_series %}
      {% for day in daily_series %}
      <div class="table-row">
        <div class="date-cell">
          <div class="day-name">{{ day.date|date:"D" }}</div>
          <div class="day-date">{{ day.date|date:"M d, Y" }}</div>
        </div>
        <div class="amount-cell sales-cell">
          {{ day.total_sales|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="amount-cell profit-cell">
          {{ day.net_profit|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="amount-cell cash-in-cell">
          {{ day.cash_in|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="amount-cell cash-out-cell">
          {{ day.cash_out|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="text-right">
          {{ day.transactions_count|default:0 }}
        </div>
        <div class="text-right">
          {{ day.items_sold|default:0 }}
        </div>
      </div>
      {% endfor %}

      <!-- Total Row -->
      <div class="table-footer">
        <div>TOTAL</div>
        <div class="amount-cell sales-cell">
          {{ period_stats.total_sales|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="amount-cell profit-cell">
          {{ period_stats.total_profit|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="amount-cell cash-in-cell">
          {{ cash_flow.cash_in|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="amount-cell cash-out-cell">
          {{ cash_flow.cash_out|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="text-right">
          {{ period_stats.total_transactions|default:0 }}
        </div>
        <div class="text-right">
          {{ period_stats.total_items_sold|default:0 }}
        </div>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No financial data available</h4>
        <p class="text-muted">Select a different date range</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Financial Analysis -->
  <div class="financial-analysis">
    <div class="section-title">
      <i class="fas fa-chart-pie"></i>Financial Analysis
    </div>

    <div class="analysis-grid">
      <!-- Gross Profit -->
      <div class="analysis-card">
        <div class="analysis-title">
          <i class="fas fa-chart-line text-success"></i>Gross Profit
        </div>
        <div class="analysis-value text-success">
          {{ total_summary.total_gross_profit|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="analysis-details">
          Total gross profit before expenses<br>
          Average daily: {{ total_summary.avg_daily_gross_profit|default:0|floatformat:0|intcomma }} AED
        </div>
      </div>

      <!-- Collection Rate -->
      <div class="analysis-card">
        <div class="analysis-title">
          <i class="fas fa-percent text-info"></i>Collection Rate
        </div>
        <div class="analysis-value text-info">
          {{ collection_rate|default:0|floatformat:1 }}%
        </div>
        <div class="analysis-details">
          Amount collected vs total sales<br>
          Outstanding: {{ payment_stats.total_outstanding|default:0|floatformat:0|intcomma }} AED
        </div>
      </div>

      <!-- Average Transaction -->
      <div class="analysis-card">
        <div class="analysis-title">
          <i class="fas fa-calculator text-primary"></i>Avg Transaction
        </div>
        <div class="analysis-value text-primary">
          {{ total_summary.avg_transaction_value|default:0|floatformat:0|intcomma }} AED
        </div>
        <div class="analysis-details">
          Average value per transaction<br>
          Total items: {{ total_summary.total_items_sold|default:0|intcomma }}
        </div>
      </div>

      <!-- Customer Statistics -->
      <div class="analysis-card">
        <div class="analysis-title">
          <i class="fas fa-users text-warning"></i>Customers
        </div>
        <div class="analysis-value text-warning">
          {{ total_summary.total_customers|default:0|intcomma }}
        </div>
        <div class="analysis-details">
          Unique customers in period<br>
          {% if total_summary.days_count > 0 %}
          {{ total_summary.total_customers|default:0|floatformat:1 }} per day
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <a href="{% url 'daily_sale:daily_summary' %}?type={{ report_type }}&date={{ target_date|date:'Y-m-d' }}"
      class="btn btn-success">
      <i class="fas fa-file-excel me-1"></i>Export to Excel
    </a>
    <button onclick="window.print()" class="btn btn-outline">
      <i class="fas fa-print me-1"></i>Print Report
    </button>
    <a href="{% url 'daily_sale:daily_summary' %}" class="btn btn-outline">
      <i class="fas fa-chart-bar me-1"></i>View Dashboard
    </a>
    <a href="{% url 'daily_sale:transaction_list' %}" class="btn btn-primary">
      <i class="fas fa-list me-1"></i>View All Transactions
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Auto-refresh every 10 minutes
    setInterval(function () {
      window.location.reload();
    }, 600000); // 10 minutes
  });

  function navigateDate(direction) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentDate = new Date('{{ target_date|date:"Y-m-d" }}');
    const reportType = '{{ report_type }}';

    if (reportType === 'daily') {
      if (direction === 'prev') {
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 1);
      }
    } else if (reportType === 'weekly') {
      if (direction === 'prev') {
        currentDate.setDate(currentDate.getDate() - 7);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
    } else if (reportType === 'monthly') {
      if (direction === 'prev') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
    } else if (reportType === 'yearly') {
      if (direction === 'prev') {
        currentDate.setFullYear(currentDate.getFullYear() - 1);
      } else {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
      }
    }

    const newDate = currentDate.toISOString().split('T')[0];
    urlParams.set('date', newDate);
    window.location.search = urlParams.toString();
  }
</script>
{% endblock %}