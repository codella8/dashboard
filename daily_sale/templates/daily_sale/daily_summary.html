{% extends "daily_sale/daily_sale_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Almuqbil | Daily Summary{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-chart-line me-2"></i>Daily Summary | Almuqbil
      </h1>
      <p class="text-muted mb-0">Real-time sales analytics and financial overview</p>
    </div>
    <div>
      <span class="text-muted me-3">
        <i class="fas fa-clock"></i> Last updated: {% now "H:i:s" %}
      </span>
      <a href="{% url 'daily_sale:daily_summary' %}" class="btn btn-primary">
        <i class="fas fa-sync-alt me-1"></i> Refresh
      </a>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error_message }}
  </div>
  {% endif %}

  <div class="card border-0 shadow mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="card-title text-white mb-3">
            <i class="fas fa-calendar-range me-2"></i>Select Date Range
          </h5>
          <form method="get" class="row g-3">
            <div class="col-md-4">
              <label class="form-label text-white">Start Date</label>
              <input type="date" class="form-control" name="start_date" 
                     value="{{ start_date|date:'Y-m-d' }}" required>
            </div>
            <div class="col-md-4">
              <label class="form-label text-white">End Date</label>
              <input type="date" class="form-control" name="end_date" 
                     value="{{ end_date|date:'Y-m-d' }}" required>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="submit" class="btn btn-light w-100">
                <i class="fas fa-filter me-1"></i> Apply Range
              </button>
            </div>
          </form>
        </div>
        <div class="col-md-4">
          <div class="text-center">
            <h2 class="text-white mb-1">{{ daily_series|length }}</h2>
            <p class="text-white-50 mb-0">Days Analyzed</p>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex flex-wrap gap-2">
            <a href="?start_date={% now 'Y-m-d' %}&end_date={% now 'Y-m-d' %}"
               class="btn btn-sm btn-outline-light">Today</a>
            <a href="?start_date={{ yesterday|date:'Y-m-d' }}&end_date={{ yesterday|date:'Y-m-d' }}"
               class="btn btn-sm btn-outline-light">Yesterday</a>
            <a href="?start_date={{ week_start|date:'Y-m-d' }}&end_date={% now 'Y-m-d' %}"
               class="btn btn-sm btn-outline-light">This Week</a>
            <a href="?start_date={{ month_start|date:'Y-m-d' }}&end_date={% now 'Y-m-d' %}"
               class="btn btn-sm btn-outline-light">This Month</a>
            <a href="?start_date={{ last_month_start|date:'Y-m-d' }}&end_date={{ last_month_end|date:'Y-m-d' }}"
               class="btn btn-sm btn-outline-light">Last Month</a>
            <a href="?start_date={{ year_start|date:'Y-m-d' }}&end_date={% now 'Y-m-d' %}"
               class="btn btn-sm btn-outline-light">This Year</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-primary text-uppercase mb-1">Total Sales</h6>
              <h2 class="mb-0">AED {{ period_stats.total_sales|default:0|floatformat:0|intcomma }}</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-shopping-cart me-1"></i>
                  {{ period_stats.total_transactions|default:0 }} transactions
                </span>
              </div>
            </div>
            <div class="icon text-primary">
              <i class="fas fa-cash-register fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-success text-uppercase mb-1">Cash In</h6>
              <h2 class="mb-0">AED {{ cash_in_total|default:0|floatformat:0|intcomma }}</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-arrow-down me-1"></i>
                  {{ cash_in_count|default:0 }} payments
                </span>
              </div>
            </div>
            <div class="icon text-success">
              <i class="fas fa-money-bill-wave fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-danger text-uppercase mb-1">Cash Out</h6>
              <h2 class="mb-0">AED {{ cash_out_total|default:0|floatformat:0|intcomma }}</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-arrow-up me-1"></i>
                  {{ cash_out_count|default:0 }} expenses
                </span>
              </div>
            </div>
            <div class="icon text-danger">
              <i class="fas fa-file-invoice-dollar fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-info text-uppercase mb-1">Net Profit</h6>
              <h2 class="mb-0 {% if net_profit|default:0 >= 0 %}text-success{% else %}text-danger{% endif %}">
                AED {{ net_profit|default:0|floatformat:0|intcomma }}
              </h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-chart-line me-1"></i>
                  Cash In - Cash Out
                </span>
              </div>
            </div>
            <div class="icon text-info">
              <i class="fas fa-chart-bar fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-success text-uppercase mb-1">Fully Paid</h6>
              <h2 class="mb-0">{{ payment_stats.fully_paid|default:0 }}</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-check-circle me-1"></i>
                  {{ payment_stats.fully_paid_percentage|default:0|floatformat:0 }}% of total
                </span>
              </div>
            </div>
            <div class="icon text-success">
              <i class="fas fa-check fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-warning text-uppercase mb-1">Partial Paid</h6>
              <h2 class="mb-0">{{ payment_stats.partially_paid|default:0 }}</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-clock me-1"></i>
                  {{ payment_stats.partially_paid_percentage|default:0|floatformat:0 }}% of total
                </span>
              </div>
            </div>
            <div class="icon text-warning">
              <i class="fas fa-clock fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-danger text-uppercase mb-1">Unpaid</h6>
              <h2 class="mb-0">{{ payment_stats.unpaid|default:0 }}</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-exclamation-triangle me-1"></i>
                  {{ payment_stats.unpaid_percentage|default:0|floatformat:0 }}% of total
                </span>
              </div>
            </div>
            <div class="icon text-danger">
              <i class="fas fa-exclamation-triangle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-info text-uppercase mb-1">Collection Rate</h6>
              <h2 class="mb-0">{{ collection_rate|default:0|floatformat:1 }}%</h2>
              <div class="mt-2">
                <span class="text-muted small">
                  <i class="fas fa-percent me-1"></i>
                  Collected vs Sales
                </span>
              </div>
            </div>
            <div class="icon text-info">
              <i class="fas fa-percent fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Daily Breakdown
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th class="text-end">Total Sales</th>
                  <th class="text-end">Cash In</th>
                  <th class="text-end">Cash Out</th>
                  <th class="text-end">Profit</th>
                  <th class="text-end">Transactions</th>
                </tr>
              </thead>
              <tbody>
                {% for day in daily_series %}
                <tr>
                  <td>
                    <strong>{{ day.date|date:"D" }}</strong><br>
                    <small class="text-muted">{{ day.date|date:"M d, Y" }}</small>
                  </td>
                  <td class="text-end">
                    <strong>AED {{ day.total_sales|default:0|floatformat:0|intcomma }}</strong>
                  </td>
                  <td class="text-end text-success">
                    AED {{ day.cash_in|default:0|floatformat:0|intcomma }}
                  </td>
                  <td class="text-end text-danger">
                    AED {{ day.cash_out|default:0|floatformat:0|intcomma }}
                  </td>
                  <td class="text-end {% if day.profit|default:0 >= 0 %}text-success{% else %}text-danger{% endif %}">
                    <strong>AED {{ day.profit|default:0|floatformat:0|intcomma }}</strong>
                  </td>
                  <td class="text-end">
                    <span class="badge bg-info">{{ day.transactions_count|default:0 }}</span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center py-4">
                    <div class="text-muted">
                      <i class="fas fa-calendar-times fa-3x mb-3"></i>
                      <h5>No data available</h5>
                      <p>Select a different date range</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th>TOTAL</th>
                  <th class="text-end">AED {{ period_stats.total_sales|default:0|floatformat:0|intcomma }}</th>
                  <th class="text-end text-success">AED {{ cash_in_total|default:0|floatformat:0|intcomma }}</th>
                  <th class="text-end text-danger">AED {{ cash_out_total|default:0|floatformat:0|intcomma }}</th>
                  <th class="text-end {% if net_profit|default:0 >= 0 %}text-success{% else %}text-danger{% endif %}">
                    AED {{ net_profit|default:0|floatformat:0|intcomma }}
                  </th>
                  <th class="text-end">{{ period_stats.total_transactions|default:0 }}</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Old Summary</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card border-left-danger">
                <div class="card-body">
                  <h6 class="text-danger">Total Outstanding</h6>
                  <h3>AED {{ payment_stats.total_outstanding|default:0|floatformat:0|intcomma }}</h3>
                  <small class="text-muted">Across {{ payment_stats.unpaid|default:0 }} transactions</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card border-left-warning">
                <div class="card-body">
                  <h6 class="text-warning">Collection Rate</h6>
                  <h3>{{ collection_rate|default:0|floatformat:0 }}%</h3>
                  <small class="text-muted">Collected vs Total Sales</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card border-left-info">
                <div class="card-body">
                  <h6 class="text-info">Avg Transaction</h6>
                  <h3>AED {{ period_stats.avg_transaction|default:0|floatformat:0|intcomma }}</h3>
                  <small class="text-muted">Average per transaction</small>
                </div>
              </div>
            </div>
          </div>
          <div class="text-center mt-3">
            <a href="{% url 'daily_sale:old_transactions' %}" class="btn btn-outline-danger">
              <i class="fas fa-eye me-1"></i> View Outstanding Customers
            </a>
            <a href="{% url 'daily_sale:cleared_transactions' %}" class="btn btn-outline-success ms-2">
              <i class="fas fa-check-circle me-1"></i> View Cleared Transactions
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- بدون جاوااسکریپت -->
{% endblock %}