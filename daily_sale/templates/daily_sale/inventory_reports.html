{% extends "base.html" %}
{% load static humanize %}

{% block title %}Inventory Reports - Inventory System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="inventory-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h3 mb-2">üì¶ Inventory Intelligence</h1>
                        <p class="text-muted mb-0">Smart inventory management and stock analysis</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="exportInventoryReport()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="inventory-card p-4">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-0">Total Products</h6>
                        <h3 class="text-dark mb-0">{{ total_products }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="inventory-card p-4">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-0">Low Stock Items</h6>
                        <h3 class="text-warning mb-0">{{ total_low_stock }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="inventory-card p-4">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-0">Top Sellers</h6>
                        <h3 class="text-success mb-0">{{ top_sellers|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="inventory-card p-4">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-0">No Sales</h6>
                        <h3 class="text-danger mb-0">{{ no_sales|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Low Stock Alert -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="inventory-card p-0 overflow-hidden">
                <div class="card-header bg-warning text-dark">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Low Stock Alert
                            </h5>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-dark">{{ low_stock|length }} items need attention</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Current Stock</th>
                                    <th>Minimum Threshold</th>
                                    <th>Status</th>
                                    <th>Last Sale</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in low_stock %}
                                <tr>
                                    <td>
                                        <strong>{{ item.product_name }}</strong>
                                        {% if item.code %}
                                        <br><small class="text-muted">Code: {{ item.code }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-danger fw-bold">{{ item.in_stock_qty }}</span>
                                    </td>
                                    <td>10</td>
                                    <td>
                                        <span class="badge bg-danger">Critical</span>
                                    </td>
                                    <td>
                                        {% if item.total_sold_count > 0 %}
                                        <small class="text-muted">{{ item.total_sold_count }} sales</small>
                                        {% else %}
                                        <small class="text-muted">No sales</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-plus me-1"></i>Restock
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                                        <h6 class="text-success">All items are well stocked!</h6>
                                        <p class="text-muted small">No low stock items found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Top Selling Products -->
        <div class="col-xl-6 mb-4">
            <div class="inventory-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">üèÜ Best Selling Products</h5>
                    <span class="badge bg-success">{{ top_sellers|length }} products</span>
                </div>

                {% for product in top_sellers %}
                <div class="border-bottom pb-3 mb-3">
                    <div class="row align-items-center">
                        <div class="col-7">
                            <h6 class="mb-1">{{ product.product_name }}</h6>
                            <div class="d-flex gap-3">
                                <small class="text-muted">
                                    Stock: {{ product.in_stock_qty }}
                                </small>
                                <small class="text-muted">
                                    Sold: {{ product.total_sold_qty }}
                                </small>
                            </div>
                            <div class="stock-indicator {% if product.in_stock_qty > 20 %}high-stock{% elif product.in_stock_qty > 10 %}medium-stock{% else %}low-stock{% endif %}"></div>
                        </div>
                        <div class="col-5 text-end">
                            <h6 class="text-success mb-1">${{ product.unit_price|floatformat:0|intcomma }}</h6>
                            <small class="text-muted">
                                {{ product.total_sold_count }} transactions
                            </small>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No sales data available</h6>
                    <p class="text-muted small">Top sellers will appear here once products are sold</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Products with No Sales -->
        <div class="col-xl-6 mb-4">
            <div class="inventory-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">üì¶ Products with No Sales</h5>
                    <span class="badge bg-warning">{{ no_sales|length }} products</span>
                </div>

                {% for product in no_sales %}
                <div class="border-bottom pb-3 mb-3">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h6 class="mb-1">{{ product.product_name }}</h6>
                            <div class="d-flex gap-3">
                                <small class="text-muted">
                                    Stock: {{ product.in_stock_qty }}
                                </small>
                                <small class="text-muted">
                                    Price: ${{ product.unit_price|floatformat:0 }}
                                </small>
                            </div>
                            <div class="stock-indicator {% if product.in_stock_qty > 20 %}high-stock{% elif product.in_stock_qty > 10 %}medium-stock{% else %}low-stock{% endif %}"></div>
                        </div>
                        <div class="col-4 text-end">
                            <span class="badge bg-secondary">No Sales</span>
                            <div class="mt-1">
                                <small class="text-muted">Added: {{ product.created_at|date:"M d" }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h6 class="text-success">All products have sales!</h6>
                    <p class="text-muted small">Great job moving your inventory</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Inventory Health Summary -->
    <div class="row">
        <div class="col-12">
            <div class="inventory-card p-4">
                <h5 class="mb-4">‚ù§Ô∏è Inventory Health Summary</h5>
                
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="position-relative">
                            <canvas id="stockHealthChart" width="200" height="200"></canvas>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <h4 class="mb-0">{{ total_products }}</h4>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="stock-indicator high-stock me-3" style="width: 30px;"></div>
                                    <div>
                                        <h6 class="mb-0 text-success">Well Stocked</h6>
                                        <small class="text-muted">Items with >20 units</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="stock-indicator medium-stock me-3" style="width: 30px;"></div>
                                    <div>
                                        <h6 class="mb-0 text-warning">Moderate Stock</h6>
                                        <small class="text-muted">Items with 10-20 units</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <div class="stock-indicator low-stock me-3" style="width: 30px;"></div>
                                    <div>
                                        <h6 class="mb-0 text-danger">Low Stock</h6>
                                        <small class="text-muted">Items with <10 units</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <div class="bg-secondary me-3" style="width: 30px; height: 8px; border-radius: 4px;"></div>
                                    <div>
                                        <h6 class="mb-0 text-secondary">No Stock</h6>
                                        <small class="text-muted">Out of stock items</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Inventory Recommendations</h6>
                            <div class="alert alert-light border">
                                <small>
                                    <ul class="mb-0">
                                        <li>Restock {{ low_stock|length }} critical items immediately</li>
                                        <li>Consider promotions for {{ no_sales|length }} non-moving items</li>
                                        <li>Monitor stock levels for top {{ top_sellers|length }} sellers</li>
                                        <li>Review pricing strategy for low-performing items</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportInventoryReport() {
    // In a real implementation, this would generate and download an inventory report
    alert('Inventory report export would generate a comprehensive stock analysis');
}

// Simple stock health chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('stockHealthChart').getContext('2d');
    
    // Mock data - in real implementation, this would come from the backend
    const stockData = {
        healthy: {{ total_products|add:"-10" }},  // Mock healthy count
        low: {{ total_low_stock }},
        out: 2  // Mock out of stock count
    };
    
    // This is a placeholder for chart implementation
    console.log('Stock Health Chart would be implemented here with data:', stockData);
});
</script>
{% endblock %}